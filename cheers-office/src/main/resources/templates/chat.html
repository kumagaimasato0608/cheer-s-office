<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>Cheers Office - ãƒãƒ£ãƒƒãƒˆ</title>

<link rel="stylesheet" th:href="@{/css/style.css}" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<style>
/* === ğŸ” æ²ç¤ºæ¿é¢¨æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ === */
.search-box {
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 5px 8px;
  margin-bottom: 4px;
}
.search-box input {
  border: none;
  outline: none;
  flex: 1;
  font-size: 14px;
}
.search-box input::placeholder {
  color: #aaa;
}
.search-hint {
  display: block;
  text-align: center;
  font-size: 11px;
  color: #777;
  margin-bottom: 8px;
}
/* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
html, body {
  overflow: hidden;
}
body {
  margin: 0;
  background: #e6f0ff;
  color: #333;
  font-family: 'Arial', sans-serif;
}
main {
  display: flex;
  height: calc(100vh - 120px);
  margin-top: 120px;
  padding: 15px;
  gap: 15px;
}
.room-list {
  width: 280px;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  padding: 15px;
  display: flex;
  flex-direction: column;
}
#roomList {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}
.room-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  margin-bottom: 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s;
  border: 1px solid transparent;
  position: relative;
}
.room-item:hover {
  background-color: #f0f5ff;
}
.room-item.active {
  background-color: #e6f0ff;
  border-color: #007bff;
  font-weight: bold;
}
.room-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #007bff;
}
.room-name {
  font-weight: bold;
  color: #333;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.button-stack {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}
.create-room, .delete-room {
  text-align: center;
  border-radius: 6px;
  padding: 12px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  transition: .2s;
  color: #fff;
  border: none;
}
.create-room {
  background-color: #007bff;
}
.create-room:hover { background-color: #0056b3; }
.delete-room {
  background-color: #dc3545;
}
.delete-room:hover { background-color: #c82333; }

.notification-badge {
  position: absolute;
  /* top: 6px; */ /* â† å‰Šé™¤ */
  /* right: 8px; */ /* â† å‰Šé™¤ */
  top: 50%;      /* â˜… è¿½åŠ : ä¸Šä¸‹ä¸­å¤®ã«é…ç½® */
  right: 20px;     /* â˜… å¤‰æ›´: å³ç«¯ã‹ã‚‰ã®è·é›¢ã‚’å°‘ã—å¢—ã‚„ã™ (20pxç¨‹åº¦ã«èª¿æ•´) */
  transform: translateY(-50%); /* â˜… è¿½åŠ : ä¸Šä¸‹ä¸­å¤®æƒãˆã®ãŸã‚ã®èª¿æ•´ */
  min-width: 18px;
  height: 18px;
  background-color: #dc3545;
  border-radius: 9px;
  color: white;
  font-size: 11px;
  font-weight: bold;
  display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
  justify-content: center;
  align-items: center;
  line-height: 1;
  padding: 0 5px;
  box-sizing: border-box;
}
.notification-badge.visible {
  display: inline-flex; /* è¡¨ç¤ºçŠ¶æ…‹ */
}
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}
.chat-header {
  padding: 15px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.2em;
  font-weight: bold;
}
.messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
  scroll-behavior: smooth;
  background-color: #f4f6fc;
}
.msg-wrapper {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  width: 100%;
}
.msg-wrapper.me { justify-content: flex-end; }
.msg-wrapper.other { justify-content: flex-start; }
.msg-content-wrapper { display: flex; flex-direction: column; max-width: 65%; }
.msg-wrapper.me .msg-content-wrapper { align-items: flex-end; }
.msg-meta { font-size: 12px; color: #6c757d; margin-bottom: 4px; padding: 0 5px; }
.msg {
  padding: 10px 15px;
  border-radius: 15px;
  font-size: 14px;
  box-shadow: 0 2px 4px rgba(0,0,0,.08);
  display: inline-block;
  max-width: 100%;
  word-wrap: break-word;
  white-space: pre-wrap;
  line-height: 1.5;
}
.me .msg {
  background: #007bff;
  color: white;
  border-bottom-right-radius: 5px;
}
.other .msg {
  background: #ffffff;
  color: #333;
  border: 1px solid #e9ecef;
  border-bottom-left-radius: 5px;
}
.msg-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #ccc;
  cursor: pointer;
}
.chat-image-standalone { max-width: 100%; max-height: 250px; border-radius: 10px; cursor: pointer; display: block; }
.chat-image-standalone + .msg { margin-top: 5px; }
.msg-body { display: flex; align-items: flex-end; gap: 8px; }
.msg-wrapper.me .msg-body { flex-direction: row; justify-content: flex-end; }
.msg-read-status {
  order: -1;
  font-size: 11px;
  color: #6c757d;
  white-space: nowrap;
  margin-right: 6px;
  align-self: flex-end;
}
.message-container { display: flex; flex-direction: column; }
.input-area {
  display: none;
  flex-direction: column;
  border-top: 1px solid #dee2e6;
  background: #f8f9fa;
}
.input-controls { display: flex; gap: 10px; padding: 15px; align-items: flex-end; }
#messageInput {
  flex: 1;
  border: 1px solid #ced4da;
  border-radius: 6px;
  padding: 10px 12px;
  background: #fff;
  color: #333;
  font-size: 1em;
  line-height: 1.5;
  resize: vertical;
  min-height: 44px;
  box-sizing: border-box;
}
#messageInput:focus {
  border-color: #80bdff;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
.input-controls button {
  height: 44px;
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: bold;
  padding: 0 16px;
  cursor: pointer;
  transition: background-color 0.2s;
  flex-shrink: 0;
}
.input-controls .send-btn { background: #007bff; }
.send-btn:hover { background: #0056b3; }
.input-controls button.attach-btn {
  background: #6c757d;
  font-size: 24px;
  padding: 0 10px;
  line-height: 44px;
}
.attach-btn:hover { background: #5a6268; }
.image-preview-area { display: none; padding: 8px 15px; background-color: #e9ecef; position: relative; }
.preview-image { max-height: 90px; border-radius: 6px; border: 1px solid #ccc; }
.preview-remove { position: absolute; top: 0; right: 8px; width: 22px; height: 22px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; border: 1px solid white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
.chat-main.drag-over { box-shadow: 0 0 0 4px #007bff inset; }
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, .5); display: none; align-items: center; justify-content: center; z-index: 9999; }
.modal-content {
  background: #ffffff;
  border-radius: 10px;
  padding: 20px;
  width: 450px;
  color: #333;
  box-shadow: 0 5px 15px rgba(0,0,0,.5);
}
.modal-content h3 { color: #333; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.user-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
.user-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #007bff; }
.modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.modal-btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; color: #fff; cursor: pointer; }
.modal-btn.create { background: #007bff; }
.modal-btn.cancel { background: #6c757d; }
.group-icon-area { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; }
.group-icon-preview { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #007bff; object-fit: cover; }
.group-icon-label { font-size: 12px; color: #007bff; cursor: pointer; text-decoration: underline; }
.group-name-input { width: 100%; box-sizing: border-box; height: 40px; border: 1px solid #ced4da; border-radius: 6px; padding: 0 12px; background: #fff; color: #333; text-align: center; }
.selected-members-area {
  margin-top: 20px;
  text-align: left;
}
.members-title {
  font-size: 0.9em;
  font-weight: bold;
  color: #6c757d;
  margin-bottom: 8px;
  padding-bottom: 5px;
  border-bottom: 1px solid #dee2e6;
}
.members-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 110px;
  overflow-y: auto;
  padding: 5px;
}
.member-item {
  display: flex;
  align-items: center;
  gap: 6px;
  background-color: #e9ecef;
  padding: 4px 8px;
  border-radius: 15px;
  font-size: 13px;
}
.member-icon {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  object-fit: cover;
}
.member-name {
  color: #333;
}
.profile-modal-content {
  width: 400px;
  padding: 0;
  text-align: center;
}
.profile-header {
  background-color: #f0f5ff;
  padding: 20px;
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  position: relative;
}
.profile-icon {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 4px solid #fff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  object-fit: cover;
  margin-bottom: 10px;
}
.profile-username {
  font-size: 1.5em;
  font-weight: bold;
  color: #333;
  margin: 0;
}
.profile-status-message {
  color: #6c757d;
  margin-top: 5px;
  min-height: 1.2em;
}
.profile-body {
  padding: 20px 25px;
  text-align: left;
}
.profile-info-row {
  display: flex;
  margin-bottom: 15px;
  font-size: 14px;
}
.profile-info-label {
  width: 80px;
  font-weight: bold;
  color: #6c757d;
  flex-shrink: 0;
}
.profile-info-value {
  color: #333;
}
.profile-modal-buttons {
  padding: 15px;
  border-top: 1px solid #dee2e6;
  display: flex;
  justify-content: center;
}
/* === æ—¥ä»˜åŒºåˆ‡ã‚Š === */
.date-separator {
  text-align: center;
  color: #6c757d;
  font-size: 13px;
  font-weight: bold;
  margin: 15px 0;
  position: relative;
}
.date-separator::before,
.date-separator::after {
  content: "";
  position: absolute;
  top: 50%;
  width: 35%;
  height: 1px;
  background: #dee2e6;
}
.date-separator::before { left: 0; }
.date-separator::after { right: 0; }
</style>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<main id="chatRoot" th:inline="none">
<aside class="room-list">
    <div class="search-box">
      <span></span>
      <input
        type="text"
        id="roomSearchInput"
        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã‚°ãƒ«ãƒ¼ãƒ—åã§æ¤œç´¢"
        onkeydown="if(event.key==='Enter'){event.preventDefault(); searchRooms();}">
    </div>
    <small class="search-hint">å…¥åŠ›ã—ã¦[Enterã‚­ãƒ¼]ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>
    <div id="roomList"></div>

    <div class="button-stack">
        <div class="create-room" id="openCreateBtn">ï¼‹ æ–°è¦ãƒãƒ£ãƒƒãƒˆ</div>
        <div class="delete-room" id="openDeleteBtn">ğŸ—‘ï¸ ãƒãƒ£ãƒƒãƒˆå‰Šé™¤</div>
    </div>
</aside>

<section class="chat-main">
<div class="chat-header"><span id="headerTitle">ãƒ«ãƒ¼ãƒ æœªé¸æŠ</span></div>
<div class="messages" id="messages"></div>

<div class="input-area" id="inputArea">
<div id="previewArea" class="image-preview-area"></div>
<div class="input-controls">
<input type="file" id="fileInput" accept="image/*" style="display: none;" />
<textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"></textarea>
<button id="attachFileBtn" class="attach-btn" title="ç”»åƒã‚’æ·»ä»˜">ğŸ–¼ï¸</button>
<button id="sendBtn" class="send-btn" disabled>é€ä¿¡</button>
</div>
</div>
</section>

<div class="modal-backdrop" id="createModal">
<div class="modal-content">
<h3>ğŸ‘¥ ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ã‚’é¸æŠ</h3>
<div id="userList"></div>
<div class="modal-buttons">
<button class="modal-btn create" id="createRoomBtn">ä½œæˆ</button>
<button class="modal-btn cancel" id="cancelCreateBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>
</div>

<div class="modal-backdrop" id="groupModal">
<div class="modal-content">
<h3>ğŸ‘‘ ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</h3>
<div class="group-icon-area">
<img src="/images/groups/default-group-icon.png" id="groupIconPreview" class="group-icon-preview" />
<label for="groupIconInput" class="group-icon-label">ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ</label>
<input type="file" id="groupIconInput" accept="image/*" style="display: none;" />
</div>
<input type="text" id="groupNameInput" class="group-name-input" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›" />
<div class="selected-members-area">
<h4 class="members-title">ãƒ¡ãƒ³ãƒãƒ¼</h4>
<div id="selectedMemberList" class="members-list"></div>
</div>

<div class="modal-buttons">
<button class="modal-btn create" id="createGroupBtn">ä½œæˆ</button>
<button class="modal-btn cancel" id="cancelGroupBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>
</div>

<div class="modal-backdrop" id="deleteModal">
<div class="modal-content">
<h3>ğŸ—‘ï¸ ãƒãƒ£ãƒƒãƒˆå‰Šé™¤ç¢ºèª</h3>
<p>ã“ã®ãƒãƒ£ãƒƒãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚å±¥æ­´ã‚‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚</p>
<div class="modal-buttons">
<button class="modal-btn cancel" id="cancelDeleteBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button class="modal-btn create" id="confirmDeleteBtn">å‰Šé™¤ã™ã‚‹</button>
</div>
</div>
</div>

<div class="modal-backdrop" id="profileModal">
<div class="modal-content profile-modal-content">
<div class="profile-header">
<img src="/images/default_icon.png" class="profile-icon" id="profileIcon" />
<h3 class="profile-username" id="profileUsername"></h3>
<p class="profile-status-message" id="profileStatus"></p>
</div>
<div class="profile-body">
<div class="profile-info-row">
<span class="profile-info-label">æ‰€å±</span>
<span class="profile-info-value" id="profileGroup"></span>
</div>
<div class="profile-info-row">
<span class="profile-info-label">è¶£å‘³</span>
<span class="profile-info-value" id="profileHobby"></span>
</div>
<div class="profile-info-row">
<span class="profile-info-label">ãƒã‚¤ãƒ–ãƒ¼ãƒ </span>
<span class="profile-info-value" id="profileMyBoom"></span>
</div>
</div>
<div class="profile-modal-buttons">
<button class="modal-btn cancel" id="closeProfileBtn">é–‰ã˜ã‚‹</button>
</div>
</div>
</div>
</main>

<script>
let me = { id: "", name: "" };
let users = [];
let rooms = [];
let currentRoom = null;
let stomp = null;
let sub = null;
let selectedFile = null;
let notificationCounts = {};

const DEFAULT_ICON = "/images/default_icon.png";
const DEFAULT_GROUP_ICON = "/images/groups/default-group-icon.png";

function jstTime(iso) { try { return new Date(iso).toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" }); } catch (e) { return ""; }};
function scrollToBottom() { const box = $("#messages")[0]; if (box) box.scrollTop = box.scrollHeight; };
function getOtherId(room) { return (room.members || []).find(id => id !== me.id); }
function findUser(id) { return users.find(u => u.userId === id); }
function getOtherUser(room) { return findUser(getOtherId(room)); }
function getOtherUserName(room) { return (getOtherUser(room)?.userName) || "ãƒãƒ£ãƒƒãƒˆ"; }
function getOtherUserIcon(room) { return (getOtherUser(room)?.icon) || DEFAULT_ICON; }
function escapeHtml(str) { return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

function renderRooms(roomsToRender) {
    const displayRooms = roomsToRender || rooms;
    const $list = $("#roomList").empty();
    if (!displayRooms.length) {
        const keyword = $('#roomSearchInput').val().trim();
        const message = keyword ? "è©²å½“ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“" : "ã¾ã ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“";
        $list.append(`<div style="text-align:center; color:#777; padding:20px 0;">${message}</div>`);
        return;
    }
    displayRooms.forEach(r => {
        const active = (currentRoom && currentRoom.roomId === r.roomId) ? "active" : "";
        const isGroupChat = (r.roomName && (r.members || []).length > 2);
        const name = isGroupChat ? r.roomName : getOtherUserName(r);
        const icon = isGroupChat ? (r.icon || DEFAULT_GROUP_ICON) : getOtherUserIcon(r);
        const count = notificationCounts[r.roomId] || 0;

        $list.append(
            `<div class="room-item ${active}" data-room-id="${r.roomId}">
                <img src="${icon}" class="room-icon" />
                <span class="room-name">${escapeHtml(name)}</span>
                <span class="notification-badge ${count > 0 ? 'visible' : ''}">${count}</span>
            </div>`
        );
    });
}

function renderHeader() {
  if (!currentRoom) {
    $("#headerTitle").text("ãƒ«ãƒ¼ãƒ æœªé¸æŠ");
    return;
  }
  const isGroupChat = currentRoom.roomName && (currentRoom.members || []).length > 2;
  let title = "";
  if (isGroupChat) {
    const memberNames = (currentRoom.members || [])
      .map(id => {
        const user = (id === me.id) ? me : findUser(id);
        return user ? (user.name || user.userName) : null;
      })
      .filter(name => name);

    title = `${escapeHtml(currentRoom.roomName)}ï¼ˆ${memberNames.join('ã€')}ï¼‰`;
  } else {
    title = getOtherUserName(currentRoom);
  }
  $("#headerTitle").text(title);
}

function renderMessages(msgs) {
  const $msgs = $("#messages").empty();
  let lastDate = ""; // ç›´å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¥ä»˜ã‚’ä¿æŒ

  (msgs || []).forEach(m => {
    const msgDate = new Date(m.timestamp).toLocaleDateString("ja-JP", {
      year: "numeric", month: "2-digit", day: "2-digit"
    });

    // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰åŒºåˆ‡ã‚Šã‚’æŒ¿å…¥
    if (msgDate !== lastDate) {
      $msgs.append(`<div class="date-separator">${msgDate}</div>`);
      lastDate = msgDate;
    }

    const isMine = (m.userId === me.id);
    const wrapperClass = isMine ? "me" : "other";
    const user = findUser(m.userId) || { userName: m.userName, icon: m.icon };

    let readStatusHtml = '';
    if (isMine && m.readBy && currentRoom) {
      const otherReadersCount = (m.readBy || []).filter(id => id !== me.id).length;

      if ((currentRoom.members || []).length > 2 && otherReadersCount > 0) {
        readStatusHtml = `<span class="msg-read-status">æ—¢èª­ ${otherReadersCount}</span>`;
      } else if ((currentRoom.members || []).length === 2 && otherReadersCount > 0) {
        readStatusHtml = `<span class="msg-read-status">æ—¢èª­</span>`;
      }
    }

    let messageBodyHtml = '';
    if (m.type === 'IMAGE') {
      messageBodyHtml = `<img src="${m.content}" alt="æ·»ä»˜ç”»åƒ" class="chat-image-standalone" onclick="window.open('${m.content}')">`;
      if (m.caption) messageBodyHtml += `<div class="msg">${escapeHtml(m.caption)}</div>`;
    } else {
      messageBodyHtml = `<div class="msg">${escapeHtml(m.content || "")}</div>`;
    }

    const html = `
    <div class="msg-wrapper ${wrapperClass}" data-user-id="${m.userId}" data-message-id="${m.messageId}">
      ${!isMine ? `<img src="${user.icon || DEFAULT_ICON}" class="msg-icon" />` : "" }
      <div class="msg-content-wrapper">
        <div class="msg-meta">${escapeHtml(user.userName || "ä¸æ˜")}ã€€${jstTime(m.timestamp)}</div>
        <div class="msg-body">
          ${readStatusHtml}
          <div class="message-container">${messageBodyHtml}</div>
        </div>
      </div>
    </div>`;
    $msgs.append(html);
  });

  scrollToBottom();
}


function subscribeRoom(roomId) {
  if (!stomp || !stomp.connected) return;
  if (sub) sub.unsubscribe();
  sub = stomp.subscribe(`/topic/chat/${roomId}`, msg => {
    const payload = JSON.parse(msg.body);

    // --- æ—¢èª­é€šçŸ¥ã®å‡¦ç† ---
    if (payload.type === 'READ_UPDATE') {
      const { messageId, readBy } = payload;
      const $msgWrapper = $(`.msg-wrapper[data-message-id="${messageId}"]`);

      if ($msgWrapper.hasClass('me')) {
        const otherReadersCount = (readBy || []).filter(id => id !== me.id).length;
        let statusText = '';

        if ((currentRoom.members || []).length > 2 && otherReadersCount > 0) {
          statusText = `æ—¢èª­ ${otherReadersCount}`;
        } else if ((currentRoom.members || []).length === 2 && otherReadersCount > 0) {
          statusText = 'æ—¢èª­';
        }

        if (statusText) {
          const $statusSpan = $msgWrapper.find('.msg-read-status');
          if ($statusSpan.length > 0) $statusSpan.text(statusText);
          else $msgWrapper.find('.msg-body').prepend(`<span class="msg-read-status">${statusText}</span>`);
        }
      }
      return;
    }

    // --- æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç† ---
    const isMine = (payload.userId === me.id);
    const user = findUser(payload.userId) || { userName: payload.userName, icon: payload.icon };
    let messageBodyHtml = '';
    if (payload.type === 'IMAGE') {
      messageBodyHtml = `<img src="${payload.content}" alt="æ·»ä»˜ç”»åƒ" class="chat-image-standalone" onclick="window.open('${payload.content}')">`;
      if (payload.caption) messageBodyHtml += `<div class="msg">${escapeHtml(payload.caption)}</div>`;
    } else {
      messageBodyHtml = `<div class="msg">${escapeHtml(payload.content || "")}</div>`;
    }

    const html = `
    <div class="msg-wrapper ${isMine ? 'me' : 'other'}" data-user-id="${payload.userId}" data-message-id="${payload.messageId}">
      ${!isMine ? `<img src="${user.icon || DEFAULT_ICON}" class="msg-icon" />` : "" }
      <div class="msg-content-wrapper">
        <div class="msg-meta">${escapeHtml(user.userName || "ä¸æ˜")}ã€€${jstTime(payload.timestamp)}</div>
        <div class="msg-body">
          <div class="message-container">
            ${messageBodyHtml}
          </div>
        </div>
      </div>
    </div>`;
    $("#messages").append(html);
    scrollToBottom();

    if (!isMine && document.visibilityState === 'visible') {
      stomp.send(`/app/chat/${roomId}/read`, {}, JSON.stringify({ messageId: payload.messageId, userId: me.id }));
    }
  });
}

function loadMe() { return $.getJSON("/api/users/me").then(res => { me.id = res.userId; me.name = res.userName; }); }
function loadUsers() { return $.getJSON("/api/users").then(res => { users = (res || []).filter(u => u.userId !== me.id); }); }
function loadMessages(roomId) { return $.getJSON(`/api/chat/${roomId}`); }

function connectWS(cb) {
  if (stomp && stomp.connected) {
    if (cb) cb();
    return;
  }
  const sock = new SockJS("/ws");
  stomp = Stomp.over(sock);
  stomp.debug = null;
  stomp.connect({}, () => {
    if (me.id) {
      stomp.subscribe(`/topic/notifications/${me.id}`, msg => {
        const notification = JSON.parse(msg.body);
        if (notification.type === 'NEW_MESSAGE') {
          if (!currentRoom || currentRoom.roomId !== notification.roomId) {
            notificationCounts[notification.roomId] = (notificationCounts[notification.roomId] || 0) + 1;
            renderRooms();
          }
        }
      });
    }
    if (typeof cb === "function") cb();
  });
}

// â–¼â–¼â–¼ â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ã•ã‚ŒãŸé–¢æ•°ã§ã™ â˜…â˜…â˜… â–¼â–¼â–¼
function selectRoomById(roomId) {
  const room = rooms.find(r => r.roomId === roomId);
  if(!room) return;

  // 1. ãƒãƒƒã‚¸ã‚’å…ˆã«æ¶ˆã™
  notificationCounts[roomId] = 0;
  currentRoom = room;
  renderRooms();
  renderHeader();
  $("#inputArea").css("display", "flex");
  $("#sendBtn").prop("disabled", false);

  // 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã‚€
  loadMessages(roomId).then(loadedMessages => {

    // â˜… ä¿®æ­£: æ—¢èª­ã«ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’ã™ã¹ã¦ä¿å­˜ã™ã‚‹é…åˆ—
    const unreadMessageIds = [];

    // 3. ã€è‡ªåˆ†ç”¨ã®ä¿®æ­£ã€‘
    // ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ *å‰* ã«ã€æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ä¸Šã§æ—¢èª­ã«ã™ã‚‹
    (loadedMessages || []).forEach(msg => {
        if (msg.userId !== me.id && !(msg.readBy || []).includes(me.id)) {
            if (!msg.readBy) {
                msg.readBy = [];
            }
            msg.readBy.push(me.id); // ãƒ­ãƒ¼ã‚«ãƒ«ã® 'readBy' ãƒªã‚¹ãƒˆã«è‡ªåˆ†ã‚’è¿½åŠ 

            // â˜… ä¿®æ­£: æœ€å¾Œã®1ä»¶ã ã‘ã§ãªãã€ã™ã¹ã¦ã®æœªèª­IDã‚’ä¿å­˜
            unreadMessageIds.push(msg.messageId);
        }
    });

    // 4. æ—¢èª­ã«æ›¸ãæ›ãˆãŸãƒ‡ãƒ¼ã‚¿ã§ç”»é¢ã‚’æç”»ã™ã‚‹ (è‡ªåˆ†ã®ç”»é¢ãŒæ­£ã—ããªã‚‹)
    renderMessages(loadedMessages);

    // 5. WebSocketã«æ¥ç¶š
    connectWS(() => {
      subscribeRoom(roomId);

      // 6. â˜… ä¿®æ­£: unreadMessageIdsé…åˆ—ã«IDãŒ1ä»¶ã§ã‚‚ã‚ã‚Œã°
      if (unreadMessageIds.length > 0) {

          // 6a. ã€ã‚µãƒ¼ãƒãƒ¼ç”¨ã®ä¿®æ­£ã€‘
          // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ *1å›ã ã‘* æ›´æ–°
          stomp.send(`/app/chat/${roomId}/markAllAsRead`, {}, JSON.stringify({ userId: me.id }));

          // 6b. ã€ç›¸æ‰‹ç”¨ã®ä¿®æ­£ã€‘
          // ç›¸æ‰‹ï¼ˆé€ä¿¡è€…ï¼‰ã«ã€Œæ—¢èª­ã€ã‚’ä¼ãˆã‚‹ãŸã‚ã€
          // æ—¢èª­ã«ã—ãŸ *ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸* ã«ã¤ã„ã¦ 'read' ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹
          unreadMessageIds.forEach(msgId => {
             stomp.send(`/app/chat/${roomId}/read`, {}, JSON.stringify({
                  messageId: msgId,
                  userId: me.id
              }));
          });
      }
    });
  });
}
// â–²â–²â–² â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã¯ã“ã“ã¾ã§ã§ã™ â˜…â˜…â˜… â–²â–²â–²

function sendMessage() {
  if(!currentRoom || !stomp || !stomp.connected) return;
  const text = $("#messageInput").val().trim();
  if(!text && !selectedFile) return;
  if(selectedFile) uploadAndSendMessage(selectedFile, text);
  else sendTextMessage(text);
}

function sendTextMessage(text) {
  const meUser = findUser(me.id) || me;
  const payload = { roomId: currentRoom.roomId, userId: me.id, userName: me.name, type: "TEXT", content: text, timestamp: new Date().toISOString(), icon: meUser.icon || DEFAULT_ICON };
  stomp.send(`/app/chat/${payload.roomId}`, {}, JSON.stringify(payload));
  $("#messageInput").val("").css("height", "44px");
}

function uploadAndSendMessage(file, caption) {
  const formData = new FormData();
  formData.append("file", file);
  $("#sendBtn, #attachFileBtn").prop("disabled", true);
  $.ajax({ url: "/api/chat/upload", method: "POST", data: formData, processData: false, contentType: false })
    .done(res => {
      if(res && res.imageUrl) {
        const meUser = findUser(me.id) || me;
        const payload = { roomId: currentRoom.roomId, userId: me.id, userName: me.name, type: "IMAGE", content: res.imageUrl, caption: caption, timestamp: new Date().toISOString(), icon: meUser.icon || DEFAULT_ICON };
        stomp.send(`/app/chat/${payload.roomId}`, {}, JSON.stringify(payload));
        clearPreview();
        $("#messageInput").val("").css("height", "44px");
      }
    }).fail(() => alert("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—"))
    .always(() => $("#sendBtn, #attachFileBtn").prop("disabled", false));
}

function setupPreview(file) {
  if(!file.type.startsWith("image/")) { alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  selectedFile = file;
  const reader = new FileReader();
  reader.onload = e => $("#previewArea").html(
    `<div class="preview-container">
      <img src="${e.target.result}" class="preview-image" />
      <button class="preview-remove">Ã—</button>
    </div>`).show();
  reader.readAsDataURL(file);
}
function clearPreview() {
  selectedFile = null;
  $("#fileInput").val("");
  $("#previewArea").empty().hide();
}

function openCreateModal() {
  const $ul = $("#userList").empty();
  users.forEach(u => $ul.append(
    `<div class="user-row">
      <img src="${u.icon || DEFAULT_ICON}" class="user-icon" />
      <label><input type="checkbox" name="targetUser" value="${u.userId}" />${escapeHtml(u.userName)}</label>
    </div>`
  ));
  $("#createModal").css("display", "flex");
}

function createRoom() {
  const selectedUsers = $('input[name="targetUser"]:checked').map(function() { return $(this).val(); }).get();
  if (selectedUsers.length === 0) { alert("ç›¸æ‰‹ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if (selectedUsers.length === 1) {
    createSingleChat(selectedUsers[0]);
  } else {
    window.selectedGroupMembers = [me.id, ...selectedUsers];
    const $memberList = $("#selectedMemberList").empty();
    window.selectedGroupMembers.forEach(id => {
      const user = (id === me.id) ? me : findUser(id);
      if (user) {
        const userName = (id === me.id) ? user.name : user.userName;
        const userIcon = user.icon || DEFAULT_ICON;
        $memberList.append(
          `<div class="member-item">
            <img src="${userIcon}" class="member-icon" />
            <span class="member-name">${escapeHtml(userName)}</span>
          </div>`
        );
      }
    });
    $("#createModal").hide();
    $("#groupModal").css("display", "flex");
  }
}

function createSingleChat(targetId) {
  $.ajax({ url: "/api/rooms", method: "POST", contentType: "application/json", data: JSON.stringify({ members: [me.id, targetId] }) })
    .then(newRoom => {
      if (!rooms.some(r => r.roomId === newRoom.roomId)) { rooms.push(newRoom); }
      renderRooms();
      $("#createModal").hide();
      selectRoomById(newRoom.roomId);
    });
}

function openDeleteModal() {
  if(!currentRoom) { alert("å‰Šé™¤ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  $("#deleteModal").css("display", "flex");
}

function deleteRoomConfirm() {
  if(!currentRoom) return;
  const rid = currentRoom.roomId;
  $.ajax({ url: `/api/rooms/${rid}`, method: "DELETE" })
    .then(() => {
      rooms = rooms.filter(r => r.roomId !== rid);
      currentRoom = null;
      renderRooms();
      renderHeader();
      $("#messages").empty();
      $("#inputArea").hide();
      $("#deleteModal").hide();
    });
}

function uploadGroupIcon(file) {
  const formData = new FormData();
  formData.append("file", file);
  return $.ajax({ url: "/api/rooms/uploadIcon", method: "POST", data: formData, processData: false, contentType: false })
    .then(response => response.iconUrl);
}

function createGroupRoom(name, icon) {
  const payload = { members: window.selectedGroupMembers, roomName: name, icon: icon };
  $.ajax({ url: "/api/rooms", method: "POST", contentType: "application/json", data: JSON.stringify(payload) })
    .then(newRoom => {
      if (!rooms.some(r => r.roomId === newRoom.roomId)) { rooms.push(newRoom); }
      renderRooms();
      $("#groupModal").hide();
      resetGroupModal();
      selectRoomById(newRoom.roomId);
    });
}

function resetGroupModal() {
  $("#groupNameInput").val("");
  $("#groupIconInput").val("");
  $("#groupIconPreview").attr("src", DEFAULT_GROUP_ICON);
  $("#selectedMemberList").empty();
  window.selectedGroupMembers = [];
}

$(async function init() {
    // â˜…â˜…â˜… ã“ã® CSRF è¨­å®šã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ  â˜…â˜…â˜…
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    if (token && header) {
        $.ajaxSetup({
            beforeSend: function(xhr) {
                // console.log("â˜… beforeSend ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ â˜… ãƒ˜ãƒƒãƒ€ãƒ¼:", header, "ãƒˆãƒ¼ã‚¯ãƒ³:", token); // ãƒ‡ãƒãƒƒã‚°ç”¨
                xhr.setRequestHeader(header, token);
            }
        });
        // console.log("CSRF setup complete. Header:", header, "Token:", token); // ãƒ‡ãƒãƒƒã‚°ç”¨
    } else {
        console.error("CSRF token meta tags not found!");
    }
    // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    $(document).on("click", ".room-item", function() { selectRoomById($(this).data("room-id")); });
    $(document).on("click", ".preview-remove", clearPreview);
    $("#sendBtn").on("click", sendMessage);
    $("#messageInput").on("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    $("#messageInput").on("input", function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    $("#attachFileBtn").on("click", () => { if (!$("#attachFileBtn").prop("disabled")) $("#fileInput").click(); });
    $("#fileInput").on("change", function(e) { if (e.target.files.length > 0) setupPreview(e.target.files[0]); });

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    const $chatMain = $(".chat-main");
    $chatMain.on({
        "dragover": (e) => { e.preventDefault(); e.stopPropagation(); $chatMain.addClass("drag-over"); },
        "dragleave": (e) => { e.preventDefault(); e.stopPropagation(); $chatMain.removeClass("drag-over"); },
        "drop": (e) => { e.preventDefault(); e.stopPropagation(); $chatMain.removeClass("drag-over"); if (e.originalEvent.dataTransfer.files.length > 0) setupPreview(e.originalEvent.dataTransfer.files[0]); }
    });

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«
    $("#messages").on("click", ".msg-wrapper.other .msg-icon", function() {
        const userId = $(this).closest(".msg-wrapper").data("user-id");
        if (!userId) return;

        $.getJSON(`/api/users/${userId}`).done(fullUser => { // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã®ã§CSRFä¸è¦
            if (fullUser) {
                $("#profileIcon").attr("src", fullUser.icon || DEFAULT_ICON);
                $("#profileUsername").text(fullUser.userName || "ä¸æ˜");
                $("#profileStatus").text(fullUser.statusMessage || "");
                $("#profileGroup").text(fullUser.group || "æœªè¨­å®š");
                $("#profileHobby").text(fullUser.hobby || "æœªè¨­å®š");
                $("#profileMyBoom").text(fullUser.myBoom || "æœªè¨­å®š");
                $("#profileModal").css("display", "flex");
            }
        }).fail(() => {
            alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
    });
    $("#closeProfileBtn, #profileModal").on("click", function(e) {
        if (e.target === this || $(e.target).is("#closeProfileBtn")) {
            $("#profileModal").hide();
        }
    });
    $(".profile-modal-content").on("click", function(e) {
        e.stopPropagation();
    });

    // æ–°è¦ãƒ»å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
    $("#openCreateBtn").on("click", openCreateModal);
    $("#cancelCreateBtn").on("click", () => $("#createModal").hide());
    $("#createRoomBtn").on("click", createRoom);
    $("#openDeleteBtn").on("click", openDeleteModal);
    $("#cancelDeleteBtn").on("click", () => $("#deleteModal").hide());
    $("#confirmDeleteBtn").on("click", deleteRoomConfirm);

    // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
    $("#createGroupBtn").on("click", function() {
        const groupName = $("#groupNameInput").val().trim();
        const iconFile = $("#groupIconInput")[0].files[0];
        if (!groupName) { alert("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
        if (iconFile) {
            uploadGroupIcon(iconFile).then(iconUrl => createGroupRoom(groupName, iconUrl))
                .catch(() => { alert("ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); });
        } else {
            createGroupRoom(groupName, DEFAULT_GROUP_ICON);
        }
    });
    $("#cancelGroupBtn").on("click", function() { $("#groupModal").hide(); resetGroupModal(); });
    $("#groupIconInput").on("change", function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = e => $("#groupIconPreview").attr("src", e.target.result);
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    // --- åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
    try {
        await loadMe();
        await loadUsers();

        await $.getJSON("/api/rooms").then(res => { // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã®ã§CSRFä¸è¦
            rooms = (res || []).filter(r => (r.members || []).includes(me.id));

            // æ—¢èª­ã‚«ã‚¦ãƒ³ãƒˆã®åˆæœŸåŒ–
            notificationCounts = {};
            rooms.forEach(room => {
                if (room.unreadCount > 0) {
                    notificationCounts[room.roomId] = room.unreadCount;
                }
            });
        });

        renderRooms();
        connectWS(); // WebSocketã«æ¥ç¶šï¼ˆé€šçŸ¥è³¼èª­ã®ãŸã‚ï¼‰
    } catch (e) {
        console.error("åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        alert("åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
    }
});

/* === ğŸ” ãƒãƒ£ãƒƒãƒˆæ¤œç´¢æ©Ÿèƒ½ï¼ˆæ²ç¤ºæ¿ã¨åŒã˜Enterã‚­ãƒ¼ç¢ºå®šï¼‰ === */
function searchRooms() {
  const keyword = $("#roomSearchInput").val().toLowerCase().trim();
  let found = false;

  $(".room-item").each(function() {
    const roomName = $(this).find(".room-name").text().toLowerCase();
    const isVisible = roomName.includes(keyword);
    $(this).toggle(isVisible);
    if(isVisible) found = true;
  });

  // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  $("#roomList .empty-hint").remove(); // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨ã¦å‰Šé™¤
  if (!found) {
    if ($("#roomList .room-item:visible").length === 0) { // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒæœ¬å½“ã«0ã‹ç¢ºèª
      const message = keyword ? "è©²å½“ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“" : "ã¾ã ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“";
      $("#roomList").append(`<div class="empty-hint" style="text-align:center; color:#777; padding:20px 0;">${message}</div>`);
    }
  }
}
</script>
</body>
</html>