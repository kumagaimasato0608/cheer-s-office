<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Cheers Office - ホーム</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/core/main.min.css' rel='stylesheet' />
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/daygrid/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales/ja.global.min.js'></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    
    <style>
	    /* === ページ全体の基本設定 === */
	    body {
			position: relative;
			background-color: #e6f0ff; 
			font-family: "Segoe UI", "Noto Sans JP", sans-serif;
			margin: 0;
	    }

	    /* === ヘッダー === */
	    .app-header {
	        position: fixed;
	        top: 0;
	        left: 0;
	        width: 100%;
	        z-index: 1000;
	        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	        background-color: #ffffff;
	    }
	    .header-top-tier {
	        background-color: #f8f9fa;
	        padding: 10px 20px;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-bottom: 1px solid #dee2e6;
	    }
	    .app-title { font-size: 1.5em; font-weight: bold; color: #007bff; }
	    .header-nav { padding: 5px 20px; }
	    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
	    .nav-item { padding: 5px 15px; }
	    .nav-link { 
	        display: flex; 
	        flex-direction: column; 
	        align-items: center; 
	        text-decoration: none; 
	        color: #333; 
	        font-size: 0.9em; 
	        font-weight: bold; 
	        padding: 8px 15px; 
	    }
	    .nav-link:hover { color: #007bff; }
	    
	    /* ★ 追加: ログインユーザー名とログアウトボタンのコンテナ */
	    .user-info-container {
	        display: flex;
	        align-items: center;
	        gap: 15px;
	    }
	    .logged-in-user {
	        font-weight: bold;
	        color: #333;
	        font-size: 0.95em;
	    }
	    
	    .logout-item { margin-left: auto; }
	    .logout-button { background-color: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9em; }
	    .logout-button:hover { background-color: #0056b3; }
	    
	    .header-toggle-button {
	        background-color: #6c757d;
	        color: white;
	        border: none;
	        padding: 8px 18px; 
	        font-size: 0.9em;  
	        border-radius: 5px;
	        font-weight: bold;
	        display: none;
	    }

	    /* === 共通コンテンツコンテナ === */
	    .page-container {
	        max-width: 1200px;
	        margin: 20px auto; 
	        padding: 30px 40px;
	        background-color: #ffffff;
	        border-radius: 10px;
	        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
	    }
	    .page-wrapper {
	        padding: 20px;
	    }
	    
	    /* === カレンダー調整 === */
        #calendar-section {
            padding: 0 15px;
            position: relative; 
            max-height: 700px; 
        }
        .fc-toolbar-title { font-size: 1.5em; }
        .fc-daygrid-event { 
            white-space: normal; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        .fc-toolbar-chunk:nth-child(1) .fc-today-button,
        .fc-toolbar-chunk:nth-child(3) { 
            display: none !important;
        }
        .fc-day-selected {
            background-color: #e0f7fa !important;
            border: 2px solid #00bcd4 !important;
        }
        
        /* ★ モーダル内のスクロール修正 */
		#eventModal .modal-body {
	        max-height: 70vh; 
	        overflow-y: auto; 
	    }
		input[type="datetime-local"] {
		    padding-right: 5px; 
	    }

        /* === 本日の予定リスト === */
        #today-schedule-section {
            padding: 15px 0;
        }
        .today-event-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .today-event-item:last-child {
            border-bottom: none;
        }
        .event-time {
            font-weight: bold;
            color: #007bff;
            margin-right: 15px;
            width: 80px;
            flex-shrink: 0;
        }
        .event-title {
            flex-grow: 1;
        }
        
        /* === オンラインユーザー表示用スタイル === */
        .online-user-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .online-user-item:last-child {
            border-bottom: none;
        }
        .online-status-dot {
            width: 10px;
            height: 10px;
            background-color: #28a745; /* green */
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .online-user-name {
            font-weight: 500;
        }
        
        /* === おみくじスタイル === */
        .omikuji-result {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0 10px;
        }
        .omikuji-comment {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 15px;
        }
        /* ★★★ 通知バッジスタイル ★★★ */
        .notification-bar {
            display: none; /* 初期状態では非表示 (JSで件数 > 0なら表示) */
        }
		
	</style>
    
    <link rel="stylesheet" href="/css/style.css"> 
</head>
<body>

    <div th:replace="common/header :: header"></div>

    <main class="container mt-5" style="padding-top: 100px;"> 
        
        <div id="reactionNotificationBar" class="notification-bar alert alert-warning d-flex justify-content-between align-items-center mb-4" role="alert">
            <span id="notificationMessage">新しいリアクションが <span id="unseenCount">0</span> 件届いています！</span>
            <a href="/photopin" class="btn btn-sm btn-warning">PinItで確認する</a>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">✨ 本日の予定 (<span id="todayDate"></span>)</h5>
                    </div>
                    <div class="card-body p-0" id="today-schedule-section">
                        <div id="today-event-list">
                            <p class="text-center text-muted small mt-3">予定を読み込み中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="main-content-area row">

            <div class="col-lg-8">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">🗓️ 全体カレンダー</h5>
                        <button type="button" class="btn btn-sm btn-light" id="openNewEventButton">
                            + 予定追加
                        </button>
                    </div>
                    <div class="card-body" id="calendar-section">
                        <div id='home-calendar'></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">📰 新着情報 (最新スレッド)</h5>
                    </div>
                    <ul id="latest-threads-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted" id="loading-threads">
                            スレッドを読み込み中...
                        </li>
                    </ul>
                    <div class="card-footer text-center">
                        <a href="/thread" class="btn btn-sm btn-outline-success">掲示板全体を見る</a>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">🎮 PinItチームスコア</h5>
                    </div>
                    <div class="card-body">
                        <ul id="realtime-score-list" class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: red;">
                                <span>🔴 RED チーム</span>
                                <strong id="score-red">0 ポイント</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: blue;">
                                <span>🔵 BLUE チーム</span>
                                <strong id="score-blue">0 ポイント</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: gold;">
                                <span>🟡 YELLOW チーム</span>
                                <strong id="score-yellow">0 ポイント</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="text-muted small">今シーズン残り: <strong id="seasonRemainingDays">計算中...</strong></span>
                        <a href="/photopin" class="btn btn-sm btn-outline-danger">pinIt マップへ (詳細)</a>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">⛩️ 今日のおみくじ</h5>
                    </div>
                    <div class="card-body text-center">
                        <p id="omikujiDate" class="text-muted small"></p>
                        <div id="omikujiResultDisplay">
                            <p class="omikuji-result" id="omikujiResult">???</p>
                            <p class="omikuji-comment" id="omikujiComment">ボタンを押して今日の運勢を占ってみましょう！</p>
                            <button class="btn btn-warning" id="drawOmikujiButton">おみくじを引く</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">💬 チャット</h5>
                        <p class="card-text small text-muted">アクティブなチャットルームや未読情報がここに表示されます。</p>
                        <a href="/chat" class="btn btn-sm btn-outline-secondary">チャットルームへ</a>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">🟢 オンラインメンバー (<span id="onlineCount">0</span>)</h5>
                        <div id="onlineUsersList" class="list-group list-group-flush">
                            <p class="text-muted small text-center pt-2">オンライン情報を読み込み中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </main>
        
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">イベントの登録・編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">タイトル *</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3 row">
                            <div class="col-6">
                                <label for="eventStart" class="form-label">開始日時 *</label>
                                <input type="datetime-local" class="form-control" id="eventStart" required>
                            </div>
                            <div class="col-6">
                                <label for="eventEnd" class="form-label">終了日時</label>
                                <input type="datetime-local" class="form-control" id="eventEnd">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">説明/備考</label>
                            <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">🗓 共有メンバー (任意)</label>
                            <div id="sharedUsersContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                                <p class="text-muted small">ユーザー情報を読み込み中...</p>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="eventAllDay">
                            <label class="form-check-label" for="eventAllDay">終日イベント</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteEventButton" style="display: none;">削除</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="saveEventButton">登録</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="dayEventsModal" tabindex="-1" aria-labelledby="dayEventsModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayEventsModalTitle">日付の予定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dayEventsModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script src="/js/common.js"></script>
    <script src="/js/home.js"></script>
    
    <script>
        // CSRFトークンをaxiosのデフォルトヘッダーに設定
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        axios.defaults.headers.common[header] = token;
        
        // ユーティリティ関数
        const formatDate = (date) => {
             // dateオブジェクトまたはISO文字列を受け取り、"YYYY-MM-DD"形式の文字列を返す
            if (!date) return '';
            const d = (date instanceof Date) ? date : new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatTime = (isoString) => {
            if (!isoString || isoString.length < 16) return '';
            return isoString.substring(11, 16); // "HH:MM" 部分を抽出
        };
        const todayDateStr = formatDate(new Date());

        // ★★★ 修正: 文章レパートリーの追加と、ランダムシード用の設定 ★★★
        const omikujiResults = [
            // 大吉 (15%)
            { result: "大吉", comment: "絶好調！何をしても上手くいくでしょう。新しい挑戦を恐れずに！", color: "#dc3545", weight: 15 },
            // 中吉 (20%)
            { result: "中吉", comment: "まずまずの運勢。目標に向かって一歩前進！計画的に行動しましょう。", color: "#ffc107", weight: 20 },
            { result: "中吉", comment: "努力が報われる一日。周囲への感謝を忘れずに。", color: "#ffc107", weight: 20 },
            // 小吉 (25%)
            { result: "小吉", comment: "小さな幸せに感謝。地道な努力が実を結びます。午後に吉報あり。", color: "#28a745", weight: 25 },
            { result: "小吉", comment: "気分転換が吉。新しいアイデアが浮かぶかもしれません。", color: "#28a745", weight: 25 },
            // 吉 (20%)
            { result: "吉", comment: "可もなく不可もなく。現状維持を心がけて。人間関係は良好。", color: "#17a2b8", weight: 20 },
            { result: "吉", comment: "穏やかな一日。焦らず、自分のペースで進めましょう。", color: "#17a2b8", weight: 20 },
            // 末吉 (10%)
            { result: "末吉", comment: "焦りは禁物。慎重に行動すれば吉と出ます。午後の休憩で気分転換を。", color: "#007bff", weight: 10 },
            // 凶 (5%)
            { result: "凶", comment: "今日は厄日かも。大人しく過ごすのが吉。早めに帰宅しましょう。", color: "#6c757d", weight: 5 }
        ];

        let currentUserId = null; 
        let animationInterval = null; 

        // ★★★ 修正: ユーザーIDと日付に基づく乱数生成関数 (シード付き乱数) ★★★
        function seededRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // --- おみくじ機能関数 ---
        function drawOmikuji(isInitialLoad = false) {
            if (!currentUserId) {
                if (!isInitialLoad) {
                    alert("ユーザー情報が読み込まれていません。しばらく待ってから再度お試しください。");
                }
                return;
            }

            const today = formatDate(new Date());
            const localStorageKey = 'omikujiResult_' + currentUserId + '_' + today;
            const $resultEl = $('#omikujiResult');
            const $commentEl = $('#omikujiComment');
            const $button = $('#drawOmikujiButton');
            
            $('#omikujiDate').text(today);

            const storedResult = localStorage.getItem(localStorageKey);
            let result;

            if (storedResult) {
                result = JSON.parse(storedResult);
                $resultEl.text(result.result).css('color', result.color);
                $commentEl.text(result.comment).css('color', '#555');
                $button.prop('disabled', true).text('本日の結果を表示中');
                if (animationInterval) clearInterval(animationInterval);
                return;
            } 
            
            if (isInitialLoad) {
                 $button.prop('disabled', false).text('おみくじを引く');
                 return;
            }
            
            // --- 演出開始 ---
            $button.prop('disabled', true).text('運勢を占っています...');
            $commentEl.text('シャカシャカ...シャカシャカ...');

            const animationResults = omikujiResults.map(r => r.result); 

            animationInterval = setInterval(() => {
                const tempResult = animationResults[Math.floor(Math.random() * animationResults.length)];
                $resultEl.text(tempResult).css('color', '#6c757d'); 
            }, 100); 

            // 2秒後に確定
            setTimeout(() => {
                clearInterval(animationInterval);
                
                const dateSeed = new Date(today).getTime();
                const userHashMatch = currentUserId.replace(/[^0-9]/g, '').match(/\d{1,8}/);
                const userHash = userHashMatch ? parseInt(userHashMatch[0]) : 1; 
                const seed = dateSeed + userHash; 
                const random = seededRandom(seed); 
                
                let totalWeight = omikujiResults.reduce((sum, r) => sum + r.weight, 0);
                let randNum = random * totalWeight;
                
                let cumulativeWeight = 0;
                let finalResult = omikujiResults[omikujiResults.length - 1];
                
                for (let i = 0; i < omikujiResults.length; i++) {
                    cumulativeWeight += omikujiResults[i].weight;
                    if (randNum <= cumulativeWeight) {
                        finalResult = omikujiResults[i];
                        break;
                    }
                }
                
                result = finalResult;
                localStorage.setItem(localStorageKey, JSON.stringify(result));
                
                // --- 演出終了、結果表示 ---
                $resultEl.text(result.result).css('color', result.color);
                $commentEl.text(result.comment).css('color', '#555');
                $button.prop('disabled', true).text('本日の結果を表示中');
                animationInterval = null;

            }, 2000); 
        }

        // --- オンラインユーザーリスト表示関数 (省略) ---
        function renderOnlineUsers(users) {
            const listContainer = document.getElementById('onlineUsersList');
            const onlineCountEl = document.getElementById('onlineCount');
            listContainer.innerHTML = '';
            // ... (ロジック省略) ...
            if (!users || !Array.isArray(users) || users.length === 0) {
                listContainer.innerHTML = '<p class="text-muted small text-center pt-2">現在オンラインのメンバーはいません。</p>';
                onlineCountEl.textContent = '0';
                return;
            }
            onlineCountEl.textContent = users.length;
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'online-user-item';
                const iconUrl = user.icon || '/images/default_icon.png';
                item.innerHTML = `<div class="online-status-dot"></div><img src="${iconUrl}" alt="${user.userName} Icon" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;"><span class="online-user-name">${user.userName}</span>`;
                listContainer.appendChild(item);
            });
        }
        // ------------------------------------

        // --- 未読通知の更新関数 ---
        function updateUnseenReactionNotification() {
            // ★★★ バックエンドに未読件数API (/api/notifications/unseen-reactions) が必要 ★★★
            axios.get('/api/notifications/unseen-reactions')
                .then(response => {
                    const unseenCount = response.data.count; // サーバーが { "count": 5 } のように返す想定
                    const $notificationBar = $('#reactionNotificationBar');
                    const $unseenCount = $('#unseenCount');
                    
                    if (unseenCount > 0) {
                        $unseenCount.text(unseenCount);
                        $notificationBar.css('display', 'flex'); // 表示
                    } else {
                        $notificationBar.css('display', 'none'); // 非表示
                    }
                })
                .catch(error => {
                    console.error("未読リアクション数の取得に失敗しました", error);
                });
        }


        document.addEventListener('DOMContentLoaded', async function() {
            const calendarEl = document.getElementById('home-calendar');
            const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            const dayEventsModal = new bootstrap.Modal(document.getElementById('dayEventsModal'));
            const userNameEl = document.getElementById('loggedInUserName'); // ユーザー名表示要素
            const seasonRemainingDaysEl = document.getElementById('seasonRemainingDays'); // シーズン残り日数要素
            let allUsers = [];
            let calendar = null; 
            let usersById = {}; 

            // PinItの残り日数を計算する関数 (省略)
            const calculateSeasonRemaining = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const diffTime = Math.abs(lastDayOfMonth - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) - 1;
                if (diffDays >= 0 && seasonRemainingDaysEl) { seasonRemainingDaysEl.textContent = `${diffDays}日`; } else if (seasonRemainingDaysEl) { seasonRemainingDaysEl.textContent = `終了`; }
            };
            calculateSeasonRemaining();
            
            // ★ おみくじボタンイベントハンドラの設定
            $('#drawOmikujiButton').on('click', () => drawOmikuji(false));


            // 1. ユーザー情報とPinIt初期スコアの取得
            try {
                const [meRes, scoreRes, usersRes] = await Promise.all([
                    axios.get('/api/users/me'),
                    axios.get('/api/scores'),
                    axios.get('/api/users') 
                ]);
                
                currentUserId = meRes.data.userId; 
                allUsers = usersRes.data || [];
                usersById = allUsers.reduce((acc, user) => { acc[user.userId] = user; return acc; }, {});
                
                if (userNameEl) userNameEl.textContent = meRes.data.userName;

                const initialScores = scoreRes.data;
                document.getElementById('score-red').textContent = initialScores.red + ' ポイント';
                document.getElementById('score-blue').textContent = initialScores.blue + ' ポイント';
                document.getElementById('score-yellow').textContent = initialScores.yellow + ' ポイント';

                // ★★★ 初期ロード時に未読通知を確認 ★★★
                updateUnseenReactionNotification();
                
                renderSharedUsersSelection(); 
            } catch (error) {
                console.error("データの初期ロードに失敗しました", error);
                if (userNameEl) userNameEl.textContent = 'ゲスト';
            }
            
            // ★ ページロード時のおみくじ初期表示
            drawOmikuji(true);


            // ユーザー選択チェックボックスをレンダリングする関数 (省略)
            function renderSharedUsersSelection(selectedIds = []) {
                const container = document.getElementById('sharedUsersContainer');
                container.innerHTML = '';
                if (!allUsers || allUsers.length <= 1) { container.innerHTML = '<p class="text-muted small">共有できる他のユーザーはいません。</p>'; return; }
                allUsers.forEach(user => {
                    if (user.userId !== currentUserId) {
                        const isChecked = selectedIds.includes(user.userId) ? 'checked' : '';
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `<input class="form-check-input shared-user-checkbox" type="checkbox" value="${user.userId}" id="share_${user.userId}" ${isChecked}><label class="form-check-label small" for="share_${user.userId}">${user.userName}</label>`;
                        container.appendChild(div);
                    }
                });
            }

            // ... (イベントモーダル、FullCalendarロジックは省略) ...
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                // ... (FullCalendar設定省略) ...
                events: {
                    url: '/api/events',
                    failure: function() { alert('イベントの読み込みに失敗しました'); updateCalendarPlaceholder(0); },
                    success: function(rawEvents) {
                        const eventsArray = Array.isArray(rawEvents) ? rawEvents : [];
                        updateCalendarPlaceholder(eventsArray.length); 
                        const mappedEvents = eventsArray.map(event => ({
                            id: event.id, title: event.title, start: event.start, end: event.end, allDay: event.allDay, color: event.color || '#007bff',
                            extendedProps: { description: event.description, createdByUserId: event.createdByUserId, sharedWithUserIds: event.sharedWithUserIds || [] }
                        }));
                        updateTodayScheduleList(mappedEvents); 
                        const todayEl = document.querySelector(`.fc-day[data-date="${todayDateStr}"]`);
                        if(todayEl) { todayEl.classList.add('fc-day-selected'); }
                        return mappedEvents;
                    }
                },
                eventChange: function() { calendar.refetchEvents(); },
                eventAdd: function() { calendar.refetchEvents(); },
                eventRemove: function() { calendar.refetchEvents(); },
                eventDrop: async function(info) { /* ... (ロジック省略) ... */ },
                eventResize: async function(info) { /* ... (ロジック省略) ... */ }
            });
            calendar.render();
            updateCalendarPlaceholder(-1); 
            
            // WebSocket接続によるリアルタイム更新
            const sock = new SockJS('/ws'); 
            const stompClient = Stomp.over(sock);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                
                // ★ PinItのリアクション通知を購読 (バックエンドが通知を送信する想定)
                stompClient.subscribe('/topic/reactions', function(message) {
                    console.log('PinItリアクション通知を受信。');
                    updateUnseenReactionNotification(); // 通知が来たら即座に更新
                });
                
                // ... (他のWebSocket購読ロジック省略) ...
            });
        });
    </script>
</body>
</html>