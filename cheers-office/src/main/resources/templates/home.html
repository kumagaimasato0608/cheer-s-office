<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Cheers Office - ãƒ›ãƒ¼ãƒ </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    
    <style>
	    /* === ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬è¨­å®š === */
	    body {
			position: relative;
			background-color: #e6f0ff; 
			font-family: "Segoe UI", "Noto Sans JP", sans-serif;
			margin: 0;
	    }

	    /* === ãƒ˜ãƒƒãƒ€ãƒ¼ === */
	    .app-header {
	        position: fixed;
	        top: 0;
	        left: 0;
	        width: 100%;
	        z-index: 1000;
	        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	        background-color: #ffffff;
	    }
	    .header-top-tier {
	        background-color: #f8f9fa;
	        padding: 10px 20px;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-bottom: 1px solid #dee2e6;
	    }
	    .app-title { font-size: 1.5em; font-weight: bold; color: #007bff; }
	    .header-nav { padding: 5px 20px; }
	    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
	    .nav-item { padding: 5px 15px; }
	    .nav-link { 
	        display: flex; 
	        flex-direction: column; 
	        align-items: center; 
	        text-decoration: none; 
	        color: #333; 
	        font-size: 0.9em; 
	        font-weight: bold; 
	        padding: 8px 15px; 
	    }
	    .nav-link:hover { color: #007bff; }
	    
	    /* â˜… è¿½åŠ : ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
	    .user-info-container {
	        display: flex;
	        align-items: center;
	        gap: 15px;
	    }
	    .logged-in-user {
	        font-weight: bold;
	        color: #333;
	        font-size: 0.95em;
	    }
	    
	    .logout-item { margin-left: auto; }
	    .logout-button { background-color: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9em; }
	    .logout-button:hover { background-color: #0056b3; }
	    
	    .header-toggle-button {
	        background-color: #6c757d;
	        color: white;
	        border: none;
	        padding: 8px 18px; 
	        font-size: 0.9em;  
	        border-radius: 5px;
	        font-weight: bold;
	        display: none;
	    }

	    /* === å…±é€šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠ === */
	    .page-container {
	        max-width: 1200px;
	        margin: 20px auto; 
	        padding: 30px 40px;
	        background-color: #ffffff;
	        border-radius: 10px;
	        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
	    }
	    .page-wrapper {
	        padding: 20px;
	    }
	    
	    /* === ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª¿æ•´ === */
        #calendar-section {
            padding: 0 15px;
            position: relative; 
            max-height: 700px; 
        }
        .fc-toolbar-title { font-size: 1.5em; }
        .fc-daygrid-event { 
            white-space: normal; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        .fc-toolbar-chunk:nth-child(1) .fc-today-button,
        .fc-toolbar-chunk:nth-child(3) { 
            display: none !important;
        }
        .fc-day-selected {
            background-color: #e0f7fa !important;
            border: 2px solid #00bcd4 !important;
        }
        
        /* â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿®æ­£ */
		#eventModal .modal-body {
	        max-height: 70vh; 
	        overflow-y: auto; 
	    }
		input[type="datetime-local"] {
		    padding-right: 5px; 
	    }

        /* === æœ¬æ—¥ã®äºˆå®šãƒªã‚¹ãƒˆ === */
        #today-schedule-section {
            padding: 15px 0;
        }
        .today-event-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .today-event-item:last-child {
            border-bottom: none;
        }
        .event-time {
            font-weight: bold;
            color: #007bff;
            margin-right: 15px;
            width: 80px;
            flex-shrink: 0;
        }
        .event-title {
            flex-grow: 1;
        }
		
	</style>
    
    <link rel="stylesheet" href="/css/style.css"> 
</head>
<body>

    <div th:replace="common/header :: header"></div>

    <main class="container mt-5" style="padding-top: 100px;"> 
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">âœ¨ æœ¬æ—¥ã®äºˆå®š (<span id="todayDate"></span>)</h5>
                    </div>
                    <div class="card-body p-0" id="today-schedule-section">
                        <div id="today-event-list">
                            <p class="text-center text-muted small mt-3">äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="main-content-area row">

            <div class="col-lg-8">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ—“ï¸ å…¨ä½“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h5>
                        <button type="button" class="btn btn-sm btn-light" id="openNewEventButton">
                            + äºˆå®šè¿½åŠ 
                        </button>
                    </div>
                    <div class="card-body" id="calendar-section">
                        <div id='home-calendar'></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">ğŸ® pinIt ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢ (ä»Šã‚·ãƒ¼ã‚ºãƒ³æ®‹ã‚Š: <span id="seasonRemainingDays">è¨ˆç®—ä¸­...</span>)</h5>
                    </div>
                    <div class="card-body">
                        <ul id="realtime-score-list" class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: red;">
                                <span>ğŸ”´ RED ãƒãƒ¼ãƒ </span>
                                <strong id="score-red">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: blue;">
                                <span>ğŸ”µ BLUE ãƒãƒ¼ãƒ </span>
                                <strong id="score-blue">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: gold;">
                                <span>ğŸŸ¡ YELLOW ãƒãƒ¼ãƒ </span>
                                <strong id="score-yellow">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer text-center">
                        <a href="/photopin" class="btn btn-sm btn-outline-danger">pinIt ãƒãƒƒãƒ—ã¸ (è©³ç´°)</a>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“° æ–°ç€æƒ…å ± (æœ€æ–°ã‚¹ãƒ¬ãƒƒãƒ‰)</h5>
                    </div>
                    <ul id="latest-threads-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted" id="loading-threads">
                            ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </li>
                    </ul>
                    <div class="card-footer text-center">
                        <a href="/thread" class="btn btn-sm btn-outline-success">æ²ç¤ºæ¿å…¨ä½“ã‚’è¦‹ã‚‹</a>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3>ãƒ¡ãƒ³ãƒãƒ¼ã®çŠ¶æ³</h3>
                        <p class="text-muted">ï¼ˆã“ã“ã«ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚„æ´»å‹•ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h5>
                        <p class="card-text small text-muted">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚„æœªèª­æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                        <a href="/chat" class="btn btn-sm btn-outline-secondary">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¸</a>
                    </div>
                </div>
            </div>
        </div> 
    </main>
        
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ãƒ»ç·¨é›†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3 row">
                            <div class="col-6">
                                <label for="eventStart" class="form-label">é–‹å§‹æ—¥æ™‚ *</label>
                                <input type="datetime-local" class="form-control" id="eventStart" required>
                            </div>
                            <div class="col-6">
                                <label for="eventEnd" class="form-label">çµ‚äº†æ—¥æ™‚</label>
                                <input type="datetime-local" class="form-control" id="eventEnd">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">èª¬æ˜/å‚™è€ƒ</label>
                            <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ğŸ—“ å…±æœ‰ãƒ¡ãƒ³ãƒãƒ¼ (ä»»æ„)</label>
                            <div id="sharedUsersContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                                <p class="text-muted small">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="eventAllDay">
                            <label class="form-check-label" for="eventAllDay">çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteEventButton" style="display: none;">å‰Šé™¤</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" id="saveEventButton">ç™»éŒ²</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="dayEventsModal" tabindex="-1" aria-labelledby="dayEventsModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayEventsModalTitle">æ—¥ä»˜ã®äºˆå®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dayEventsModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script src="/js/common.js"></script>
    <script src="/js/home.js"></script>
    
    <script>
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’axiosã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        axios.defaults.headers.common[header] = token;
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const formatDate = (date) => {
             // dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ISOæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€"YYYY-MM-DD"å½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
            if (!date) return '';
            const d = (date instanceof Date) ? date : new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatTime = (isoString) => {
            if (!isoString || isoString.length < 16) return '';
            return isoString.substring(11, 16); // "HH:MM" éƒ¨åˆ†ã‚’æŠ½å‡º
        };
        const todayDateStr = formatDate(new Date());


        document.addEventListener('DOMContentLoaded', async function() {
            const calendarEl = document.getElementById('home-calendar');
            const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            const dayEventsModal = new bootstrap.Modal(document.getElementById('dayEventsModal'));
            const userNameEl = document.getElementById('loggedInUserName'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºè¦ç´ 
            const seasonRemainingDaysEl = document.getElementById('seasonRemainingDays'); // ã‚·ãƒ¼ã‚ºãƒ³æ®‹ã‚Šæ—¥æ•°è¦ç´ 
            let currentUserId = null;
            let allUsers = [];
            let calendar = null; // FullCalendarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä¿æŒ

            // â˜…â˜…â˜… PinItã®æ®‹ã‚Šæ—¥æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° (â‘¢) â˜…â˜…â˜…
            const calculateSeasonRemaining = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                // ä»Šæœˆã®æœ€çµ‚æ—¥ã‚’è¨ˆç®—
                const lastDayOfMonth = new Date(year, month + 1, 0);
                
                const diffTime = Math.abs(lastDayOfMonth - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) - 1; // æœ€çµ‚æ—¥ã¯å«ã‚ãªã„ãŸã‚-1
                
                if (diffDays >= 0) {
                    seasonRemainingDaysEl.textContent = `${diffDays}æ—¥`;
                } else {
                    seasonRemainingDaysEl.textContent = `çµ‚äº†`;
                }
            };
            calculateSeasonRemaining();


            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’äº‹å‰ã«å–å¾—
            try {
                const meRes = await axios.get('/api/users/me');
                currentUserId = meRes.data.userId;
                
                // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º (nullãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ã ãŒã€ã‚³ãƒ¼ãƒ‰ã®å …ç‰¢æ€§ã®ãŸã‚)
                const userNameElement = document.getElementById('loggedInUserName');
                if (userNameElement) userNameElement.textContent = meRes.data.userName;

                // â˜…â˜…â˜… PinItåˆæœŸã‚¹ã‚³ã‚¢ã®å–å¾— (â‘¢) â˜…â˜…â˜…
                const scoreRes = await axios.get('/api/scores'); // æ–°ã—ã„APIã‚’å‘¼ã³å‡ºã™
                const initialScores = scoreRes.data;
                document.getElementById('score-red').textContent = initialScores.red + ' ãƒã‚¤ãƒ³ãƒˆ';
                document.getElementById('score-blue').textContent = initialScores.blue + ' ãƒã‚¤ãƒ³ãƒˆ';
                document.getElementById('score-yellow').textContent = initialScores.yellow + ' ãƒã‚¤ãƒ³ãƒˆ';
                // â˜…â˜…â˜… ã“ã“ã¾ã§ PinIt åˆæœŸã‚¹ã‚³ã‚¢ â˜…â˜…â˜…

                const usersRes = await axios.get('/api/users');
                allUsers = usersRes.data || [];
                renderSharedUsersSelection(); 
            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ", error);
                const userNameElement = document.getElementById('loggedInUserName');
                if (userNameElement) userNameElement.textContent = 'ã‚¨ãƒ©ãƒ¼';
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
            function renderSharedUsersSelection(selectedIds = []) {
                const container = document.getElementById('sharedUsersContainer');
                container.innerHTML = '';
                
                if (!allUsers || allUsers.length <= 1) {
                     container.innerHTML = '<p class="text-muted small">å…±æœ‰ã§ãã‚‹ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                     return;
                }
                
                allUsers.forEach(user => {
                    if (user.userId !== currentUserId) {
                        const isChecked = selectedIds.includes(user.userId) ? 'checked' : '';
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input shared-user-checkbox" type="checkbox" value="${user.userId}" id="share_${user.userId}" ${isChecked}>
                            <label class="form-check-label small" for="share_${user.userId}">
                                ${user.userName}
                            </label>
                        `;
                        container.appendChild(div);
                    }
                });
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ/ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
            function openEventModal(info) {
                const isNew = info.event === undefined;
                const modalTitle = document.getElementById('eventModalLabel');
                const deleteButton = document.getElementById('deleteEventButton');
                const saveButton = document.getElementById('saveEventButton');
                const form = document.getElementById('eventForm');

                form.reset();
                deleteButton.style.display = 'none';
                document.getElementById('eventId').value = '';
                
                // æ–°è¦ä½œæˆ
                if (isNew) {
                    modalTitle.textContent = 'æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²';
                    saveButton.textContent = 'ç™»éŒ²';
                    saveButton.disabled = false;
                    form.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
                    
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const startDefault = `${year}-${month}-${day}T09:00`;

                    document.getElementById('eventStart').value = startDefault; 
                    document.getElementById('eventEnd').value = '';
                    document.getElementById('eventAllDay').checked = false; 

                    renderSharedUsersSelection([]); 
                } 
                // ç·¨é›†/é–²è¦§
                else {
                    // æ—¥ä»˜ã‚¿ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
                    dayEventsModal.hide(); 
                    
                    const event = info.event;
                    const eventProps = event.extendedProps; 
                    const canEdit = eventProps.createdByUserId === currentUserId;
                    
                    modalTitle.textContent = canEdit ? 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†' : 'ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´° (é–²è¦§ã®ã¿)';
                    saveButton.textContent = canEdit ? 'æ›´æ–°' : 'OK';
                    saveButton.disabled = !canEdit;
                    
                    document.getElementById('eventId').value = event.id;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = eventProps.description || '';
                    document.getElementById('eventStart').value = event.startStr ? event.startStr.substring(0, 16) : '';
                    document.getElementById('eventEnd').value = event.endStr ? event.endStr.substring(0, 16) : '';
                    document.getElementById('eventAllDay').checked = event.allDay;
                    
                    deleteButton.style.display = canEdit ? 'block' : 'none';
                    form.querySelectorAll('input, textarea').forEach(el => el.disabled = !canEdit);
                    
                    const sharedIds = eventProps.sharedWithUserIds || [];
                    renderSharedUsersSelection(sharedIds);
                    form.querySelectorAll('.shared-user-checkbox').forEach(el => el.disabled = !canEdit);
                }

                eventModal.show();
            }
            
            // æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ© (å¤‰æ›´ãªã—)
            document.getElementById('openNewEventButton').addEventListener('click', function() {
                openEventModal({ event: undefined });
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜/æ›´æ–°ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
            document.getElementById('saveEventButton').onclick = async function() {
                const id = document.getElementById('eventId').value;
                const title = document.getElementById('eventTitle').value;
                const start = document.getElementById('eventStart').value;
                const end = document.getElementById('eventEnd').value;
                const description = document.getElementById('eventDescription').value;
                const allDay = document.getElementById('eventAllDay').checked;
                
                if (!title || !start) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨é–‹å§‹æ—¥æ™‚ã¯å¿…é ˆã§ã™ã€‚');
                    return;
                }

                const sharedWithUserIds = Array.from(document.querySelectorAll('.shared-user-checkbox:checked'))
                                             .map(cb => cb.value);

                const eventData = {
                    id: id || null,
                    title: title,
                    start: start,
                    end: end || null,
                    description: description,
                    allDay: allDay,
                    sharedWithUserIds: sharedWithUserIds
                };

                try {
                    await axios.post('/api/events', eventData); 
                    eventModal.hide();
                    calendar.refetchEvents(); 
                    alert(`ã‚¤ãƒ™ãƒ³ãƒˆã‚’${id ? 'æ›´æ–°' : 'ç™»éŒ²'}ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ${error.response ? (error.response.data || error.response.statusText) : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}`);
                }
            };
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
            document.getElementById('deleteEventButton').onclick = async function() {
                if (!confirm('æœ¬å½“ã«ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                const id = document.getElementById('eventId').value;
                if (!id) return;
                
                try {
                    await axios.delete(`/api/events/${id}`);
                    eventModal.hide();
                    calendar.refetchEvents();
                    alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è‡ªåˆ†ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼: ${error.response ? (error.response.data || error.response.statusText) : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}`);
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (å¤‰æ›´ãªã—)
            function updateCalendarPlaceholder(eventCount) {
                const calendarContainer = document.getElementById('calendar-section');
                const placeholderId = 'calendar-placeholder';
                let placeholder = document.getElementById(placeholderId);
                
                if (eventCount === 0) {
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.id = placeholderId;
                        placeholder.className = 'text-center p-5 text-muted h4 fw-bold'; 
                        placeholder.style.position = 'absolute';
                        placeholder.style.width = '100%';
                        placeholder.style.top = '50%';
                        placeholder.style.left = '0';
                        placeholder.style.transform = 'translateY(-50%)';
                        placeholder.style.pointerEvents = 'none'; 
                        calendarContainer.appendChild(placeholder);
                    }
                    if(calendarEl.classList.contains('fc')) {
                         placeholder.textContent = 'ç¾åœ¨ã€äºˆå®šãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; 
                         calendarEl.style.opacity = '0.3'; 
                    }
                } else {
                    if (placeholder) {
                        placeholder.remove();
                    }
                    calendarEl.style.opacity = '1';
                }
            }
            
            // æœ¬æ—¥ã®äºˆå®šãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updateTodayScheduleList(allEvents) {
                const listContainer = document.getElementById('today-event-list');
                const todayDateEl = document.getElementById('todayDate');
                
                const now = new Date();
                const todayStr = formatDate(now);
                
                todayDateEl.textContent = new Intl.DateTimeFormat('ja-JP', {
                    year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'short'
                }).format(now);
                
                const todayEvents = allEvents.filter(event => {
                    const start = new Date(event.start);
                    const end = event.end ? new Date(event.end) : null;
                    const eventDateStr = formatDate(start);
                    
                    if (event.allDay) {
                         const endDateStr = end ? formatDate(end) : eventDateStr; 
                         return todayStr >= eventDateStr && todayStr < endDateStr;
                    } 
                    
                    return eventDateStr === todayStr;
                    
                }).sort((a, b) => new Date(a.start) - new Date(b.start)); 

                listContainer.innerHTML = '';
                
                if (todayEvents.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-muted small mt-3">æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                todayEvents.forEach(event => {
                    const startTime = new Date(event.start);
                    const endTime = event.end ? new Date(event.end) : null;
                    
                    const timeOptions = { hour: '2-digit', minute: '2-digit' };
                    let timeText;
                    
                    if (event.allDay) {
                        timeText = "çµ‚æ—¥";
                    } else if (endTime) {
                        timeText = `${startTime.toLocaleTimeString('ja-JP', timeOptions)} ~ ${endTime.toLocaleTimeString('ja-JP', timeOptions)}`;
                    } else {
                        timeText = startTime.toLocaleTimeString('ja-JP', timeOptions);
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'today-event-item';
                    item.style.borderLeft = `5px solid ${event.color || '#007bff'}`;
                    item.style.cursor = 'pointer';
                    item.onclick = () => openEventModal({ event: event }); // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
                    
                    item.innerHTML = `
                        <span class="event-time">${timeText}</span>
                        <span class="event-title">${event.title}</span>
                    `;
                    listContainer.appendChild(item);
                });
            }
            
            // æ—¥ä»˜ã‚¿ãƒƒãƒ—æ™‚ã®å‡¦ç† (æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º)
            const showEventsForDay = async (dateStr, allEvents) => {
                const selectedDate = new Date(dateStr);
                const listContainer = document.getElementById('dayEventsModalBody');
                
                const dateDisplay = new Intl.DateTimeFormat('ja-JP', {
                    month: 'numeric', day: 'numeric', weekday: 'short'
                }).format(selectedDate);
                
                // æ—¢ã«å–å¾—æ¸ˆã¿ã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’ç¢ºä¿)
                const dailyEvents = allEvents.filter(event => {
                    const eventDate = dateStr;
                    const start = new Date(event.start);
                    const eventStartDateStr = formatDate(start);
                    
                    if (event.allDay) {
                        const end = event.end ? new Date(event.end) : start;
                        const endDateStr = formatDate(end);
                        return eventDate >= eventStartDateStr && eventDate < endDateStr;
                    } 
                    
                    return eventStartDateStr === eventDate;
                    
                }).sort((a, b) => new Date(a.start) - new Date(b.start)); 

                document.getElementById('dayEventsModalTitle').textContent = `${dateDisplay} ã®äºˆå®š`;
                listContainer.innerHTML = ''; 

                if (dailyEvents.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-muted small mt-2">ã“ã®æ—¥ã¯äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                } else {
                    dailyEvents.forEach(event => {
                        let timeText;
                        if (event.allDay) {
                            timeText = "çµ‚æ—¥";
                        } else {
                            const startTime = new Date(event.start);
                            const endTime = event.end ? new Date(event.end) : null;
                            const timeOptions = { hour: '2-digit', minute: '2-digit' };
                            timeText = endTime ? `${startTime.toLocaleTimeString('ja-JP', timeOptions)} ~ ${endTime.toLocaleTimeString('ja-JP', timeOptions)}` : startTime.toLocaleTimeString('ja-JP', timeOptions);
                        }
                        
                        const item = document.createElement('div');
                        item.className = 'p-2 mb-2 rounded';
                        item.style.borderLeft = `5px solid ${event.color || '#007bff'}`;
                        item.style.backgroundColor = event.color + '1A';
                        item.style.cursor = 'pointer';
                        
                        item.onclick = () => openEventModal({ event: event }); 

                        item.innerHTML = `
                            <div>
                                <strong class="me-2">${timeText}</strong>
                                <span>${event.title}</span>
                            </div>
                            <div class="text-muted small mt-1 ps-3">
                                ${event.extendedProps.description || 'è©³ç´°ãªã—'}
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                }
                
                dayEventsModal.show();
            };


            // 2. FullCalendarã®åˆæœŸåŒ–
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ja',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: '' // æœˆè¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                },
                initialView: 'dayGridMonth',
                height: '500px', // é«˜ã•ã‚’æ˜ç¤ºçš„ã«è¨­å®š
                editable: true,
                dayMaxEvents: true,
                
                // æ—¥ä»˜ã‚¿ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿè£…: dateClickã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                dateClick: function(info) {
                    // FullCalendarãŒæŒã¤ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                    const allEvents = calendar.getEvents();
                    showEventsForDay(info.dateStr, allEvents);
                    
                    // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®èƒŒæ™¯è‰²ã‚’å¼·èª¿ï¼ˆCSSã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«ï¼‰
                    document.querySelectorAll('.fc-day-selected').forEach(el => el.classList.remove('fc-day-selected'));
                    info.dayEl.classList.add('fc-day-selected'); 
                },
                
                events: {
                    url: '/api/events',
                    failure: function() {
                        alert('ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        updateCalendarPlaceholder(0); 
                    },
                    success: function(rawEvents) {
                        updateCalendarPlaceholder(rawEvents.length); 
                        
                        // â˜…â˜…â˜… ä¿®æ­£: sharedWithUserIdsãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ  (â‘¡) â˜…â˜…â˜…
                        const mappedEvents = rawEvents.map(event => ({
                            id: event.id,
                            title: event.title,
                            start: event.start,
                            end: event.end,
                            allDay: event.allDay,
                            color: event.color || '#007bff',
                            extendedProps: {
                                description: event.description,
                                createdByUserId: event.createdByUserId,
                                sharedWithUserIds: event.sharedWithUserIds || [] // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç©ºãƒªã‚¹ãƒˆã‚’è¨­å®š
                            }
                        }));
                        
                        updateTodayScheduleList(mappedEvents); // æœ¬æ—¥ã®äºˆå®šã‚’æ›´æ–°

                        // åˆå›èµ·å‹•æ™‚ã®æ—¥ä»˜ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä»Šæ—¥ï¼‰
                        const todayEl = document.querySelector(`.fc-day[data-date="${todayDateStr}"]`);
                        if(todayEl) {
                           todayEl.classList.add('fc-day-selected');
                        }

                        return mappedEvents;
                    }
                },
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã®å¤‰æ›´æ™‚ã«æœ¬æ—¥ã®äºˆå®šãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ãƒ•ãƒƒã‚¯
                eventChange: function() {
                    calendar.refetchEvents(); 
                },
                eventAdd: function() {
                    calendar.refetchEvents();
                },
                eventRemove: function() {
                    calendar.refetchEvents();
                },

                // eventDrop/eventResize ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã— (ä¸­ç•¥)
                eventDrop: async function(info) {
                    const event = info.event;
                    const canEdit = event.extendedProps.createdByUserId === currentUserId;
                    if (!canEdit) { alert('è‡ªåˆ†ã®ä½œæˆã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã—ã‹ç§»å‹•ã§ãã¾ã›ã‚“ã€‚'); info.revert(); return; }
                    if (!confirm(`${event.title} ã®æ—¥ä»˜ã‚’ ${event.startStr.substring(0, 10)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) { info.revert(); return; }
                    const eventData = {
                        id: event.id, title: event.title, start: event.startStr, end: event.endStr || null, description: event.extendedProps.description, allDay: event.allDay, color: event.backgroundColor, sharedWithUserIds: event.extendedProps.sharedWithUserIds
                    };
                    try { await axios.post('/api/events', eventData); alert('ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»˜ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚'); } catch (error) { alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); info.revert(); }
                },
                
                eventResize: async function(info) {
                    const event = info.event;
                    const canEdit = event.extendedProps.createdByUserId === currentUserId;
                    if (!canEdit) { alert('è‡ªåˆ†ã®ä½œæˆã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã—ã‹æœŸé–“ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); info.revert(); return; }
                    if (!confirm(`${event.title} ã®æœŸé–“ã‚’ ${event.startStr.substring(0, 10)} ã‹ã‚‰ ${event.endStr.substring(0, 10)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) { info.revert(); return; }
                    const eventData = {
                        id: event.id, title: event.title, start: event.startStr, end: event.endStr || null, description: event.extendedProps.description, allDay: event.allDay, color: event.backgroundColor, sharedWithUserIds: event.extendedProps.sharedWithUserIds
                    };
                    try { await axios.post('/api/events', eventData); alert('ã‚¤ãƒ™ãƒ³ãƒˆæœŸé–“ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚'); } catch (error) { alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); info.revert(); }
                }
            });

            calendar.render();
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ‰‹å‹•ã§ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
            updateCalendarPlaceholder(-1); 
            
            // WebSocketæ¥ç¶šã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            const sock = new SockJS('/ws'); 
            const stompClient = Stomp.over(sock);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // â˜… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’è³¼èª­
                stompClient.subscribe('/topic/calendar', function(eventMessage) {
                    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€šçŸ¥ã‚’å—ä¿¡ã€‚æ›´æ–°ã—ã¾ã™ã€‚');
                    calendar.refetchEvents();
                });
                
                // â˜… PinItã‚¹ã‚³ã‚¢é€šçŸ¥ã‚’è³¼èª­ (ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°ç”¨) (â‘¢)
                stompClient.subscribe('/topic/scores', function(scoreMessage) {
                    const newScores = JSON.parse(scoreMessage.body);
                    
                    // ã‚¹ã‚³ã‚¢ã®æ›´æ–°
                    document.getElementById('score-red').textContent = newScores.red + ' ãƒã‚¤ãƒ³ãƒˆ';
                    document.getElementById('score-blue').textContent = newScores.blue + ' ãƒã‚¤ãƒ³ãƒˆ';
                    document.getElementById('score-yellow').textContent = newScores.yellow + ' ãƒã‚¤ãƒ³ãƒˆ';
                });
            });
        });
    </script>