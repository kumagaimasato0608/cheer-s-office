<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Cheers Office - ãƒ›ãƒ¼ãƒ </title>
	<link rel="icon" type="image/png" href="/images/cheers_office_logo.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js'></script> 
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <link rel="stylesheet" href="/css/style.css"> 

    <style>
	    /* === ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬è¨­å®š === */
	    body {
			position: relative;
			background-color: #e6f0ff; 
			font-family: "Segoe UI", "Noto Sans JP", sans-serif;
			margin: 0;
	    }

	    /* === ãƒ˜ãƒƒãƒ€ãƒ¼ === */
	    .app-header {
	        position: fixed;
	        top: 0;
	        left: 0;
	        width: 100%;
	        z-index: 1000;
	        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	        background-color: #ffffff;
	    }
	    .header-top-tier {
	        background-color: #f8f9fa;
	        padding: 10px 20px;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-bottom: 1px solid #dee2e6;
	    }
	    .app-title { font-size: 1.5em; font-weight: bold; color: #007bff; }
	    .header-nav { padding: 5px 20px; }
	    .nav-list { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
	    .nav-item { padding: 5px 15px; }
	    .nav-link { 
	        display: flex; 
	        flex-direction: column; 
	        align-items: center; 
	        text-decoration: none; 
	        color: #333; 
	        font-size: 0.9em; 
	        font-weight: bold; 
	        padding: 8px 15px; 
	    }
	    .nav-link:hover { color: #007bff; }
	    
	    /* â˜… è¿½åŠ : ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
	    .user-info-container {
	        display: flex;
	        align-items: center;
	        gap: 15px;
	    }
	    .logged-in-user {
	        font-weight: bold;
	        color: #333;
	        font-size: 0.95em;
	    }
	    
	    .logout-item { margin-left: auto; }
	    .logout-button { background-color: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9em; }
	    .logout-button:hover { background-color: #0056b3; }
	    
	    .header-toggle-button {
	        background-color: #6c757d;
	        color: white;
	        border: none;
	        padding: 8px 18px; 
	        font-size: 0.9em;  
	        border-radius: 5px;
	        font-weight: bold;
	        display: none;
	    }

	    /* === å…±é€šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠ === */
	    .page-container {
	        max-width: 1200px;
	        margin: 20px auto; 
	        padding: 30px 40px;
	        background-color: #ffffff;
	        border-radius: 10px;
	        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
	    }
	    .page-wrapper {
	        padding: 20px;
	    }
	    
	    /* === ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª¿æ•´ === */
        #calendar-section {
            padding: 0 15px;
            position: relative; 
            max-height: 700px; 
        }
        .fc-toolbar-title { font-size: 1.5em; }
        .fc-daygrid-event { 
            white-space: normal; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        .fc-toolbar-chunk:nth-child(1) .fc-today-button,
        .fc-toolbar-chunk:nth-child(3) { 
            display: none !important;
        }
        .fc-day-selected {
            background-color: #e0f7fa !important;
            border: 2px solid #00bcd4 !important;
        }
        
        /* â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¿®æ­£ */
		#eventModal .modal-body {
	        max-height: 70vh; 
	        overflow-y: auto; 
	    }
		input[type="datetime-local"] {
		    padding-right: 5px; 
	    }

        /* === æœ¬æ—¥ã®äºˆå®šãƒªã‚¹ãƒˆ === */
        #today-schedule-section {
            padding: 15px 0;
        }
        .today-event-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .today-event-item:last-child {
            border-bottom: none;
        }
        .event-time {
            font-weight: bold;
            color: #007bff;
            margin-right: 15px;
            width: 80px;
            flex-shrink: 0;
        }
        .event-title {
            flex-grow: 1;
        }
        
        /* === ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« === */
        .online-user-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .online-user-item:last-child {
            border-bottom: none;
        }
        .online-status-dot {
            width: 10px;
            height: 10px;
            background-color: #28a745; /* green */
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .online-user-name {
            font-weight: 500;
        }
        
        /* === ãŠã¿ãã˜ã‚¹ã‚¿ã‚¤ãƒ« === */
        .omikuji-result {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0 10px;
        }
        .omikuji-comment {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 15px;
        }
        /* â˜…â˜…â˜… é€šçŸ¥ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
        .notification-bar {
            /* JSã§ display: flex ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ */
            display: none; 
            font-weight: bold;
            cursor: pointer;
        }
		
	</style>
    
    <link rel="stylesheet" href="/css/style.css"> 
</head>
<body>

    <div th:replace="common/header :: header"></div>

    <main class="container mt-5" style="padding-top: 100px;"> 
        
        <div id="chatNotificationBar" class="notification-bar alert alert-danger d-flex justify-content-between align-items-center mb-4" role="alert">
            <span id="chatNotificationMessage">ãƒãƒ£ãƒƒãƒˆã§æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ <span id="unseenChatCount">0</span> ä»¶å±Šã„ã¦ã„ã¾ã™ï¼</span>
            <a th:href="@{/chat/rooms}" class="btn btn-sm btn-danger">ãƒãƒ£ãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹</a>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">âœ¨ æœ¬æ—¥ã®äºˆå®š (<span id="todayDate"></span>)</h5>
                    </div>
                    <div class="card-body p-0" id="today-schedule-section">
                        <div id="today-event-list">
                            <p class="text-center text-muted small mt-3">äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="main-content-area row">

            <div class="col-lg-8">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ—“ï¸ å…¨ä½“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h5>
                        
                        <button type="button" class="btn btn-sm btn-light" id="openNewEventButton" 
                                th:attr="data-is-admin=${#authorization.expression('hasRole(''ROLE_ADMIN'')')}"> 
                            + äºˆå®šè¿½åŠ 
                        </button>
                    </div>
                    <div class="card-body" id="calendar-section">
                        <div id='home-calendar'></div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“° æ–°ç€æƒ…å ± (æœ€æ–°ã‚¹ãƒ¬ãƒƒãƒ‰)</h5>
                    </div>
                    <ul id="latest-threads-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted" id="loading-threads">
                            ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </li>
                    </ul>
                    <div class="card-footer text-center">
                        <a href="/thread" class="btn btn-sm btn-outline-success">æ²ç¤ºæ¿å…¨ä½“ã‚’è¦‹ã‚‹</a>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">ğŸ® PinItãƒãƒ¼ãƒ ã‚¹ã‚³ã‚¢</h5>
                    </div>
                    <div class="card-body">
                        <ul id="realtime-score-list" class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: red;">
                                <span>ğŸ”´ RED ãƒãƒ¼ãƒ </span>
                                <strong id="score-red">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: blue;">
                                <span>ğŸ”µ BLUE ãƒãƒ¼ãƒ </span>
                                <strong id="score-blue">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="color: gold;">
                                <span>ğŸŸ¡ YELLOW ãƒãƒ¼ãƒ </span>
                                <strong id="score-yellow">0 ãƒã‚¤ãƒ³ãƒˆ</strong>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="text-muted small">ä»Šã‚·ãƒ¼ã‚ºãƒ³æ®‹ã‚Š: <strong id="seasonRemainingDays">è¨ˆç®—ä¸­...</strong></span>
                        <a href="/photopin" class="btn btn-sm btn-outline-danger">pinIt ãƒãƒƒãƒ—ã¸ (è©³ç´°)</a>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">â›©ï¸ ä»Šæ—¥ã®ãŠã¿ãã˜</h5>
                    </div>
                    <div class="card-body text-center">
                        <p id="omikujiDate" class="text-muted small"></p>
                        <div id="omikujiResultDisplay">
                            <p class="omikuji-result" id="omikujiResult">???</p>
                            <p class="omikuji-comment" id="omikujiComment">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä»Šæ—¥ã®é‹å‹¢ã‚’å ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                            <button class="btn btn-warning" id="drawOmikujiButton">ãŠã¿ãã˜ã‚’å¼•ã</button>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ğŸŸ¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ³ãƒãƒ¼ (<span id="onlineCount">0</span>)</h5>
                        <div id="onlineUsersList" class="list-group list-group-flush">
                            <p class="text-muted small text-center pt-2">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </main>
        
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ãƒ»ç·¨é›†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3 row">
                            <div class="col-6">
                                <label for="eventStart" class="form-label">é–‹å§‹æ—¥æ™‚ *</label>
                                <input type="datetime-local" class="form-control" id="eventStart" required>
                            </div>
                            <div class="col-6">
                                <label for="eventEnd" class="form-label">çµ‚äº†æ—¥æ™‚</label>
                                <input type="datetime-local" class="form-control" id="eventEnd">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">èª¬æ˜/å‚™è€ƒ</label>
                            <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ğŸ—“ å…±æœ‰ãƒ¡ãƒ³ãƒãƒ¼ (ä»»æ„)</label>
                            <div id="sharedUsersContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                                <p class="text-muted small">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="eventAllDay">
                            <label class="form-check-label" for="eventAllDay">çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteEventButton" style="display: none;">å‰Šé™¤</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" id="saveEventButton">ç™»éŒ²</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="dayEventsModal" tabindex="-1" aria-labelledby="dayEventsModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayEventsModalTitle">æ—¥ä»˜ã®äºˆå®š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dayEventsModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script src="/js/common.js"></script>
    <script src="/js/home.js"></script>
    
    <script th:inline="javascript">
        // (no script here)
    </script>
    
    <script>
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’axiosã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        axios.defaults.headers.common[header] = token;
        
        // --- å¤‰æ•°å®šç¾© ---
        const openNewEventButton = document.getElementById('openNewEventButton'); 
        const userIsAdmin = openNewEventButton.getAttribute('data-is-admin') === 'true'; 
        let calendar = null;
        let currentUserId = null; 
        
        // â˜…â˜…â˜… ä¿®æ­£ç‚¹: å…±æœ‰æ©Ÿèƒ½ã®ãŸã‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç§»å‹• â˜…â˜…â˜…
        let allUsers = []; 
        let usersById = {}; 
        
        let animationInterval = null; 

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const formatDate = (date) => {
             // dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ISOæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€"YYYY-MM-DD"å½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
            if (!date) return '';
            const d = (date instanceof Date) ? date : new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatTime = (isoString) => {
            if (!isoString || isoString.length < 16) return '';
            return isoString.substring(11, 16); // "HH:MM" éƒ¨åˆ†ã‚’æŠ½å‡º
        };
        const todayDateStr = formatDate(new Date());

        // â˜…â˜…â˜… ç‹¬ç«‹ã—ãŸé–¢æ•°å®šç¾©ãƒ–ãƒ­ãƒƒã‚¯ (çœç•¥) â˜…â˜…â˜…
        
        function updateCalendarPlaceholder(eventCount) {
            const placeholderEl = document.getElementById('calendar-placeholder');
            const calendarEl = document.getElementById('home-calendar');
            if (!placeholderEl || !calendarEl) return;

            if (eventCount === -1) {
                // placeholderEl.textContent = 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...'; // èª­ã¿è¾¼ã¿ä¸­ã¯éè¡¨ç¤ºã«
                calendarEl.style.opacity = '0.3';
            } else if (eventCount === 0) {
                // placeholderEl.textContent = 'ç¾åœ¨ã€ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; // 0ä»¶ã§ã‚‚éè¡¨ç¤ºã«
                calendarEl.style.opacity = '1'; // 0ä»¶ã§ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è‡ªä½“ã¯è¡¨ç¤º
            } else {
                // placeholderEl.textContent = '';
                calendarEl.style.opacity = '1';
            }
        }
        
        function updateTodayScheduleList(allEvents) {
            const listContainer = document.getElementById('today-event-list');
            const todayDateEl = document.getElementById('todayDate');
            const now = new Date();
            const todayStr = formatDate(now);
            
            todayDateEl.textContent = new Intl.DateTimeFormat('ja-JP', {
                year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'short'
            }).format(now);
            
            const todayEvents = allEvents.filter(event => {
                const start = new Date(event.start);
                const end = event.end ? new Date(event.end) : null;
                const eventDateStr = formatDate(start);
                
                if (event.allDay) {
                     // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã®é–“ã«ä»Šæ—¥ãŒå«ã¾ã‚Œã‚‹ã‹
                     const endDate = end ? new Date(end.getTime() - 1) : start; // FullCalendarã®ä»•æ§˜(çµ‚äº†æ—¥ã¯å«ã¾ãªã„)ã«åˆã‚ã›ã‚‹
                     const endDateStr = formatDate(endDate);
                     return todayStr >= eventDateStr && todayStr <= endDateStr;
                } 
                
                return eventDateStr === todayStr;
                
            }).sort((a, b) => new Date(a.start) - new Date(b.start)); 

            listContainer.innerHTML = '';
            
            if (todayEvents.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-muted small mt-3">æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            todayEvents.forEach(event => {
                const startTime = new Date(event.start);
                const endTime = event.end ? new Date(event.end) : null;
                const timeOptions = { hour: '2-digit', minute: '2-digit' };
                let timeText;
                
                if (event.allDay) {
                    timeText = "çµ‚æ—¥";
                } else if (endTime && formatDate(startTime) !== formatDate(endTime)) {
                    // è¤‡æ•°æ—¥ã«ã‚ãŸã‚‹æ™‚é–“æŒ‡å®šã‚¤ãƒ™ãƒ³ãƒˆ
                    timeText = `${startTime.toLocaleTimeString('ja-JP', timeOptions)} ~`;
                } else if (endTime) {
                    timeText = `${startTime.toLocaleTimeString('ja-JP', timeOptions)} ~ ${endTime.toLocaleTimeString('ja-JP', timeOptions)}`;
                } else {
                    timeText = startTime.toLocaleTimeString('ja-JP', timeOptions);
                }
                
                const item = document.createElement('div');
                item.className = 'today-event-item';
                item.style.borderLeft = `5px solid ${event.color || '#007bff'}`;
                item.style.cursor = 'pointer';
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (FullCalendarã®eventClickã¨é€£å‹•)
                item.onclick = () => {
                     const calEvent = calendar.getEventById(event.id);
                     if (calEvent) {
                         openEventModal({ event: calEvent });
                     } else {
                         // FullCalendaræœ¬ä½“ã«ãªã„ã‚¤ãƒ™ãƒ³ãƒˆ(åŠ å·¥å¾Œã®ãƒ‡ãƒ¼ã‚¿)ã®å ´åˆã¯ãã®ã¾ã¾æ¸¡ã™
                         openEventModal({ event: event }); 
                     }
                };

                item.innerHTML = `<span class="event-time">${timeText}</span><span class="event-title">${event.title}</span>`;
                listContainer.appendChild(item);
            });
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•° (æ–°è¦/ç·¨é›†) ---
        function openEventModal(info) {
            const isNew = info.event === undefined;
            const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            const modalTitle = document.getElementById('eventModalLabel');
            const deleteButton = document.getElementById('deleteEventButton');
            const saveButton = document.getElementById('saveEventButton');
            const form = document.getElementById('eventForm');
            
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: min/max å±æ€§ã‚’å¼·åˆ¶çš„ã«ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç† â˜…â˜…â˜…
            const eventStartEl = document.getElementById('eventStart');
            const eventEndEl = document.getElementById('eventEnd');
            
            // ã“ã‚Œã‚‰ã®å±æ€§ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯æ™‚é–“ã‚’é¸æŠã™ã‚‹éš›ã®åˆ¶é™ã‚’è§£é™¤ã—ã¾ã™ã€‚
            eventStartEl.removeAttribute('min'); 
            eventStartEl.removeAttribute('max');
            eventEndEl.removeAttribute('min');
            eventEndEl.removeAttribute('max');
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜…

            form.reset();
            deleteButton.style.display = 'none';
            document.getElementById('eventId').value = '';
            
            // æ–°è¦ä½œæˆ
            if (isNew) {
                modalTitle.textContent = 'æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²';
                saveButton.textContent = 'ç™»éŒ²';
                saveButton.disabled = false; 
                
                const now = new Date();
                const startDefault = `${formatDate(info.date || now)}T09:00`;

                document.getElementById('eventStart').value = startDefault; 
                document.getElementById('eventEnd').value = '';
                document.getElementById('eventAllDay').checked = false; 
                
                form.querySelectorAll('input, textarea').forEach(el => el.disabled = false);

                // â˜…â˜…â˜… ä¿®æ­£ç‚¹: å…±æœ‰ãƒªã‚¹ãƒˆã‚’ç©ºã®çŠ¶æ…‹ã§æç”» â˜…â˜…â˜…
                renderSharedUsersSelection([]); 
                form.querySelectorAll('.shared-user-checkbox').forEach(el => el.disabled = false);
            } 
            // ç·¨é›†/é–²è¦§
            else {
                // (info.event ã¯ FullCalendar ã® EventObject)
                const event = info.event; 
                
                // extendedProps ã‹ã‚‰ä½œæˆè€…IDã‚’å–å¾—
                const createdBy = event.extendedProps ? event.extendedProps.createdByUserId : null;
                const canEdit = userIsAdmin || (createdBy === currentUserId); 
                
                modalTitle.textContent = canEdit ? 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†' : 'ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´° (é–²è¦§ã®ã¿)';
                saveButton.textContent = canEdit ? 'æ›´æ–°' : 'OK'; 
                saveButton.disabled = !canEdit;
                
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDescription').value = event.extendedProps ? event.extendedProps.description : '';
                
                // ISO 8601å½¢å¼ ("YYYY-MM-DDTHH:MM") ã«æ•´å½¢
                const startStr = event.start ? new Date(event.start.getTime() - (event.start.getTimezoneOffset() * 60000)).toISOString().substring(0, 16) : '';
                const endStr = event.end ? new Date(event.end.getTime() - (event.end.getTimezoneOffset() * 60000)).toISOString().substring(0, 16) : '';

                document.getElementById('eventStart').value = startStr;
                document.getElementById('eventEnd').value = event.allDay ? '' : endStr; // çµ‚æ—¥ã®å ´åˆã¯çµ‚äº†ã‚’ç©ºã«
                document.getElementById('eventAllDay').checked = event.allDay;
                
                deleteButton.style.display = canEdit ? 'block' : 'none';
                form.querySelectorAll('input, textarea').forEach(el => el.disabled = !canEdit);

                // â˜…â˜…â˜… ä¿®æ­£ç‚¹: æ—¢å­˜ã®å…±æœ‰ãƒªã‚¹ãƒˆã‚’æç”»ã—ã€ç·¨é›†ä¸å¯ãªã‚‰ disabled ã«ã™ã‚‹ â˜…â˜…â˜…
                const sharedIds = (event.extendedProps && event.extendedProps.sharedWithUserIds) ? event.extendedProps.sharedWithUserIds : [];
                renderSharedUsersSelection(sharedIds);
                form.querySelectorAll('.shared-user-checkbox').forEach(el => el.disabled = !canEdit);
            }

            eventModal.show();
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜/æ›´æ–°ã™ã‚‹é–¢æ•° ---
        document.getElementById('saveEventButton').onclick = async function() {
            if (this.disabled) {
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                return;
            }

            const id = document.getElementById('eventId').value;
            const title = document.getElementById('eventTitle').value;
            const start = document.getElementById('eventStart').value;
            let end = document.getElementById('eventEnd').value;
            const description = document.getElementById('eventDescription').value;
            const allDay = document.getElementById('eventAllDay').checked;
            
            if (allDay) {
                end = null; // çµ‚æ—¥ã®å ´åˆã¯çµ‚äº†æ—¥æ™‚ã‚’nullã«ã™ã‚‹
            }
            
            if (!title || !start) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨é–‹å§‹æ—¥æ™‚ã¯å¿…é ˆã§ã™ã€‚'); return; }

            // â˜…â˜…â˜… ä¿®æ­£ç‚¹: å…±æœ‰ãƒ¡ãƒ³ãƒãƒ¼ã®IDãƒªã‚¹ãƒˆã‚’åé›† â˜…â˜…â˜…
            const sharedWithUserIds = Array.from(document.querySelectorAll('.shared-user-checkbox:checked'))
                                           .map(cb => cb.value);

            const eventData = { 
                id: id || null, 
                title: title, 
                start: start, 
                end: end || null, 
                description: description, 
                allDay: allDay,
                sharedWithUserIds: sharedWithUserIds // â˜…â˜…â˜… ä¿®æ­£ç‚¹: é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ  â˜…â˜…â˜…
            };
            
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (CalendarController) ã¯ @PostMapping ã®ã¿
            const method = 'POST';
            const url = '/api/events';

            try {
                await axios({ method: method, url: url, data: eventData }); 
                
                calendar.refetchEvents(); 
                
                alert(`ã‚¤ãƒ™ãƒ³ãƒˆã‚’${id ? 'æ›´æ–°' : 'ç™»éŒ²'}ã—ã¾ã—ãŸã€‚`);
                
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ${error.response ? (error.response.data || error.response.statusText) : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}`);
            }
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹é–¢æ•° ---
        document.getElementById('deleteEventButton').onclick = async function() {
            if (!confirm('æœ¬å½“ã«ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const id = document.getElementById('eventId').value;
            if (!id) return;
            
            try {
                await axios.delete(`/api/events/${id}`);
                
                calendar.refetchEvents();
                
                alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert(`ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ${error.response ? (error.response.data || error.response.statusText) : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}`);
            }
        };

        // â˜…â˜…â˜… ãŠã¿ãã˜æ©Ÿèƒ½ã®é–¢æ•°å®šç¾© (çœç•¥) â˜…â˜…â˜…
        const omikujiResults = [
            { result: "å¤§å‰", comment: "çµ¶å¥½èª¿ï¼ä½•ã‚’ã—ã¦ã‚‚ä¸Šæ‰‹ãã„ãã§ã—ã‚‡ã†ã€‚æ–°ã—ã„æŒ‘æˆ¦ã‚’æã‚Œãšã«ï¼", color: "#dc3545", weight: 15 },
            { result: "ä¸­å‰", comment: "ã¾ãšã¾ãšã®æ—¥ã€‚æ—¥ã€…ã®åŠªåŠ›ãŒå®Ÿã‚’çµã³ãã†ã§ã™ã€‚", color: "#ffc107", weight: 20 },
            { result: "å°å‰", comment: "å°ã•ãªå¹¸ã›ãŒã‚ã‚Šãã†ã€‚èº«ã®å›ã‚Šã«æ„Ÿè¬ã—ã¾ã—ã‚‡ã†ã€‚", color: "#198754", weight: 30 },
            { result: "å‰", comment: "å¹³ç©ãªä¸€æ—¥ã€‚ç„¡ç†ã‚’ã›ãšã€ç¾çŠ¶ç¶­æŒã‚’å¿ƒãŒã‘ã¦ã€‚", color: "#0dcaf0", weight: 20 },
            { result: "æœ«å‰", comment: "æ²¹æ–­å¤§æ•µ.åˆå¾Œã«å‘ã‘ã¦é‹æ°—ãŒä¸‹ãŒã‚Šæ°—å‘³ã‹ã‚‚ã€‚", color: "#6610f2", weight: 10 },
            { result: "å‡¶", comment: "ä»Šæ—¥ã¯å„æ—¥ã‹ã‚‚ã€‚å¤§äººã—ãéã”ã™ã®ãŒå‰ã€‚æ—©ã‚ã«å¸°å®…ã—ã¾ã—ã‚‡ã†ã€‚", color: "#6c757d", weight: 5 }
        ];

        function seededRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function drawOmikuji(isInitialLoad = false) {
            if (!currentUserId && !isInitialLoad) {
                alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                return;
            }

            const today = formatDate(new Date());
            const localStorageKey = 'omikujiResult_' + (currentUserId || 'guest') + '_' + today;
            const $resultEl = $('#omikujiResult');
            const $commentEl = $('#omikujiComment');
            const $button = $('#drawOmikujiButton');
            
            $('#omikujiDate').text(today);

            const storedResult = localStorage.getItem(localStorageKey);
            let result;

            if (storedResult) {
                result = JSON.parse(storedResult);
                $resultEl.text(result.result).css('color', result.color);
                $commentEl.text(result.comment).css('color', '#555');
                $button.prop('disabled', true).text('æœ¬æ—¥ã®çµæœã‚’è¡¨ç¤ºä¸­');
                if (animationInterval) clearInterval(animationInterval);
                return;
            } 
            
            if (isInitialLoad) {
                 $button.prop('disabled', false).text('ãŠã¿ãã˜ã‚’å¼•ã');
                 return;
            }
            
            if (!currentUserId) {
                alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }
            
            $button.prop('disabled', true).text('é‹å‹¢ã‚’å ã£ã¦ã„ã¾ã™...');
            $commentEl.text('ã‚·ãƒ£ã‚«ã‚·ãƒ£ã‚«...ã‚·ãƒ£ã‚«ã‚·ãƒ£ã‚«...');

            const animationResults = omikujiResults.map(r => r.result); 

            animationInterval = setInterval(() => {
                const tempResult = animationResults[Math.floor(Math.random() * animationResults.length)];
                $resultEl.text(tempResult).css('color', '#6c757d'); 
            }, 100); 

            setTimeout(() => {
                clearInterval(animationInterval);
                
                const dateSeed = new Date(today).getTime();
                const userHashMatch = currentUserId.replace(/[^0-9]/g, '').match(/\d{1,8}/);
                const userHash = userHashMatch ? parseInt(userHashMatch[0]) : 1; 
                const seed = dateSeed + userHash; 
                const random = seededRandom(seed); 
                
                let totalWeight = omikujiResults.reduce((sum, r) => sum + r.weight, 0);
                let randNum = random * totalWeight;
                
                let cumulativeWeight = 0;
                let finalResult = omikujiResults[omikujiResults.length - 1];
                
                for (let i = 0; i < omikujiResults.length; i++) {
                    cumulativeWeight += omikujiResults[i].weight;
                    if (randNum <= cumulativeWeight) {
                        finalResult = omikujiResults[i];
                        break;
                    }
                }
                
                result = finalResult;
                localStorage.setItem(localStorageKey, JSON.stringify(result));
                
                $resultEl.text(result.result).css('color', result.color);
                $commentEl.text(result.comment).css('color', '#555');
                $button.prop('disabled', true).text('æœ¬æ—¥ã®çµæœã‚’è¡¨ç¤ºä¸­');
                animationInterval = null;

            }, 2000); 
        }
        $('#drawOmikujiButton').on('click', () => drawOmikuji(false));
        // â˜…â˜…â˜… ãŠã¿ãã˜æ©Ÿèƒ½ã®é–¢æ•°å®šç¾©ã“ã“ã¾ã§ â˜…â˜…â˜…

        function renderOnlineUsers(users) {
            const listContainer = document.getElementById('onlineUsersList');
            const onlineCountEl = document.getElementById('onlineCount');
            listContainer.innerHTML = '';
            if (!users || !Array.isArray(users) || users.length === 0) {
                listContainer.innerHTML = '<p class="text-muted small text-center pt-2">ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                onlineCountEl.textContent = '0';
                return;
            }
            onlineCountEl.textContent = users.length;
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'online-user-item';
                const iconUrl = user.icon || '/images/default_icon.png';
                item.innerHTML = `<div class="online-status-dot"></div><img src="${iconUrl}" alt="${user.userName} Icon" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;"><span class="online-user-name">${user.userName}</span>`;
                listContainer.appendChild(item);
            });
        }
        
		function updateUnseenChatNotification() {
		            axios.get('/api/rooms')
		                .then(response => {
		                    // â˜… ä¿®æ­£ç‚¹: response.data (APIã‹ã‚‰ã®å¿œç­”ãƒ‡ãƒ¼ã‚¿) ã‚’ 'rooms' ã¨ã—ã¦æ‰±ã†
		                    const rooms = response.data || []; 
		                    
		                    // rooms é…åˆ—ã‚’èµ°æŸ»ã—ã¦ã€å„ room ã® unreadCount ã‚’åˆè¨ˆã™ã‚‹
		                    const unseenCount = rooms.reduce((sum, room) => sum + (room.unreadCount || 0), 0); 
		                    
		                    const $notificationBar = $('#chatNotificationBar');
		                    const $unseenChatCount = $('#unseenChatCount');
		                    
		                    if (unseenCount > 0) {
		                        $unseenChatCount.text(unseenCount);
		                        $notificationBar.css('display', 'flex'); 
		                    } else {
		                        $notificationBar.css('display', 'none'); 
		                    }
		                })
		                .catch(error => {
		                    console.error("æœªèª­ãƒãƒ£ãƒƒãƒˆä»¶æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", error);
							// ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯é€šçŸ¥ãƒãƒ¼ã‚’éš ã™
							$('#chatNotificationBar').css('display', 'none');
		                });
		        }
        
        // â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã“ã®é–¢æ•°ã‚’ DOMContentLoaded ã®å¤–ã«ç§»å‹• â˜…â˜…â˜…
        function renderSharedUsersSelection(selectedIds = []) {
            const container = document.getElementById('sharedUsersContainer');
            container.innerHTML = '';
            // allUsers ã¨ currentUserId ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
            if (!allUsers || allUsers.length <= 1) { 
                container.innerHTML = '<p class="text-muted small">å…±æœ‰ã§ãã‚‹ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>'; 
                return; 
            }
            
            allUsers.forEach(user => {
                // è‡ªåˆ†ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
                if (user.userId !== currentUserId) {
                    const isChecked = selectedIds.includes(user.userId) ? 'checked' : '';
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `<input class="form-check-input shared-user-checkbox" type="checkbox" value="${user.userId}" id="share_${user.userId}" ${isChecked}><label class="form-check-label small" for="share_${user.userId}">${user.userName}</label>`;
                    container.appendChild(div);
                }
            });
        }


        document.addEventListener('DOMContentLoaded', async function() {
            const calendarEl = document.getElementById('home-calendar');
            // const eventModal = new bootstrap.Modal(document.getElementById('eventModal')); // openEventModalå†…ã§éƒ½åº¦ç”Ÿæˆ
            // const dayEventsModal = new bootstrap.Modal(document.getElementById('dayEventsModal'));
            const userNameEl = document.getElementById('loggedInUserName'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºè¦ç´ 
            const seasonRemainingDaysEl = document.getElementById('seasonRemainingDays'); // ã‚·ãƒ¼ã‚ºãƒ³æ®‹ã‚Šæ—¥æ•°è¦ç´ 
            
            // â˜…â˜…â˜… ä¿®æ­£ç‚¹: let ã‚’å‰Šé™¤ (ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨) â˜…â˜…â˜…
            allUsers = []; 
            usersById = {}; 
            
            
            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨PinItåˆæœŸã‚¹ã‚³ã‚¢ã®å–å¾—
            try {
                const [meRes, scoreRes, usersRes] = await Promise.all([
                    axios.get('/api/users/me'),
                    axios.get('/api/scores'),
                    axios.get('/api/users') 
                ]);
                
                currentUserId = meRes.data.userId; 
                allUsers = usersRes.data || [];
                usersById = allUsers.reduce((acc, user) => { acc[user.userId] = user; return acc; }, {});
                
                // DOMæ›´æ–°
                if (userNameEl) userNameEl.textContent = meRes.data.userName;

                const initialScores = scoreRes.data;
                document.getElementById('score-red').textContent = initialScores.red.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ';
                document.getElementById('score-blue').textContent = initialScores.blue.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ';
                document.getElementById('score-yellow').textContent = initialScores.yellow.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ';

                updateUnseenChatNotification();
                
                // äºˆå®šè¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
                openNewEventButton.addEventListener('click', () => openEventModal({}));


            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                if (userNameEl) userNameEl.textContent = 'ã‚²ã‚¹ãƒˆ';
                updateCalendarPlaceholder(0); 
            }
            
            // â˜… ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãŠã¿ãã˜åˆæœŸè¡¨ç¤º
            drawOmikuji(true);
            
            // PinItã®æ®‹ã‚Šæ—¥æ•°ã‚’è¨ˆç®—
            const calculateSeasonRemaining = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const diffTime = Math.abs(lastDayOfMonth - now);
                // çµ‚äº†æ—¥ã¾ã§ã®ã€Œæ®‹ã‚Šæ—¥æ•°ã€ãªã®ã§ã€ç¾åœ¨æ—¥ã‚’å«ã¾ãªã„
                const diffDays = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) - 1); 
                if (seasonRemainingDaysEl) { 
                    seasonRemainingDaysEl.textContent = `${diffDays}æ—¥`; 
                }
            };
            calculateSeasonRemaining();

            // --- FullCalendarã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
            calendar = new FullCalendar.Calendar(calendarEl, {
                // index.global.min.js ã¯ DayGrid, TimeGrid ãªã©ã®åŸºæœ¬ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è‡ªå‹•ã§å«ã‚€ãŸã‚ã€pluginsæŒ‡å®šã‚’å‰Šé™¤
                initialView: 'dayGridMonth',
                locale: 'ja',
                height: 600, // é«˜ã•ã‚’å°‘ã—ç¢ºä¿
                fixedWeekCount: false, // æœˆã«ã‚ˆã£ã¦é€±ã®æ•°ã‚’å¤‰ãˆã‚‹
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿
                editable: userIsAdmin, 
                droppable: userIsAdmin,
                eventStartEditable: userIsAdmin,
                eventDurationEditable: userIsAdmin,
                
                // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ–°è¦ä½œæˆï¼‰ã¯å…¨å“¡è¨±å¯
                dateClick: function(info) {
                    openEventModal({ date: info.date });
                },
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯ï¼ˆç·¨é›†/é–²è¦§ï¼‰ã¯å…¨å“¡è¨±å¯
                eventClick: function(info) {
                    openEventModal({ event: info.event });
                },

                events: {
                    url: '/api/events', // ã“ã“ãŒ CalendarController ã® getEvents ã‚’å‘¼ã¶
                    failure: function(error) { 
                        console.error('ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        updateCalendarPlaceholder(0); 
                    },
                    success: function(rawEvents) {
                        const eventsArray = Array.isArray(rawEvents) ? rawEvents : [];
                        updateCalendarPlaceholder(eventsArray.length); 
                        
                        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ¥ãŸãƒ‡ãƒ¼ã‚¿ã‚’FullCalendarç”¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                        const mappedEvents = eventsArray.map(event => ({
                            id: event.id, 
                            title: event.title, 
                            start: event.start, 
                            end: event.end, 
                            allDay: event.allDay, 
                            color: event.color || (event.createdByUserId === currentUserId ? '#007bff' : '#28a745'), // è‡ªåˆ†ã®äºˆå®šã¨å…±æœ‰ã•ã‚ŒãŸäºˆå®šã®è‰²ã‚’å¤‰ãˆã‚‹ä¾‹
                            extendedProps: { 
                                description: event.description, 
                                createdByUserId: event.createdByUserId, 
                                sharedWithUserIds: event.sharedWithUserIds || [] 
                            }
                        }));
                        
                        // ã€Œæœ¬æ—¥ã®äºˆå®šã€ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                        updateTodayScheduleList(mappedEvents); 

                        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        const todayEl = document.querySelector(`.fc-day[data-date="${todayDateStr}"]`);
                        if(todayEl) { todayEl.classList.add('fc-day-selected'); }
                        
                        return mappedEvents;
                    }
                },
                // ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸå¾Œã®å‡¦ç† (ã‚‚ã—ã‚ã‚Œã°)
                eventDidMount: function(info) {
                    // ã“ã“ã§ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãªã©ã‚’è¿½åŠ ã§ãã‚‹
                }
            });
            
            calendar.render();
            updateCalendarPlaceholder(-1); // åˆæœŸèª­ã¿è¾¼ã¿ä¸­
            
            // WebSocketæ¥ç¶š
            const sock = new SockJS('/ws'); 
            const stompClient = Stomp.over(sock);
            stompClient.debug = null; // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’éè¡¨ç¤º
            
            stompClient.connect({}, function (frame) {
                console.log('Connected to WebSocket: ' + frame);
                
                // ãƒãƒ£ãƒƒãƒˆé€šçŸ¥
                stompClient.subscribe('/topic/chat/notifications', function(message) {
                    updateUnseenChatNotification();
                });
                
                // PinItã‚¹ã‚³ã‚¢
                stompClient.subscribe('/topic/scores', function(scoreMessage) {
                    const newScores = JSON.parse(scoreMessage.body);
                    $('#score-red').text(newScores.red.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ');
                    $('#score-blue').text(newScores.blue.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ');
                    $('#score-yellow').text(newScores.yellow.toLocaleString() + ' ãƒã‚¤ãƒ³ãƒˆ');
                });
                
                // â˜…â˜…â˜… ä¿®æ­£: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆè³¼èª­ (DOMæ“ä½œã‚’å¼·åŒ–) â˜…â˜…â˜…
                stompClient.subscribe('/topic/onlineUsers', async function(userListMessage) {
                    
                    // ã€ä¿®æ­£ç‚¹ã€‘: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€åˆã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒªã‚¹ãƒˆãŒæ¥ãŸæ™‚ç‚¹ã§ã€Œèª­ã¿è¾¼ã¿ä¸­ã€çŠ¶æ…‹ã‚’è§£é™¤
                    const listContainer = document.getElementById('onlineUsersList');
                    // jQueryã§ã¯ãªãæ¨™æº–DOMæ“ä½œã§ã€å­è¦ç´ ã® <p> ã‚¿ã‚°ã‚’å…¨ã¦å‰Šé™¤
                    Array.from(listContainer.querySelectorAll('p')).forEach(p => p.remove()); 

                    const onlineUserIds = JSON.parse(userListMessage.body);
                    console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆã‚’å—ä¿¡:', onlineUserIds);
                    
                    // å—ä¿¡ã—ãŸIDãƒªã‚¹ãƒˆã‚’ä½¿ã£ã¦ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒã—ã¦ã„ã‚‹ allUsers ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    const onlineUsers = allUsers.filter(user => onlineUserIds.includes(user.userId));
                    
                    // æŠ½å‡ºã—ãŸã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’ä½¿ã£ã¦è¡¨ç¤ºã‚’æ›´æ–°
                    renderOnlineUsers(onlineUsers);
                });

                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°é€šçŸ¥
                stompClient.subscribe('/topic/calendar', function(eventMessage) {
                    console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°é€šçŸ¥ã‚’å—ä¿¡');
                    calendar.refetchEvents();
                });
            });
        });
    </script>
</body>
</html>