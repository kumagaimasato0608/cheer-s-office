<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Cheers Office - æ²ç¤ºæ¿</title>
  
  <link rel="stylesheet" th:href="@{/css/style.css}">
  
  <link rel="stylesheet" th:href="@{/css/thread.css}"> 
  
  <link rel="icon" type="image/png" href="/images/cheers_office_logo.png">

</head>

<body>
  <header th:replace="~{common/header :: header}"></header>

  <main>
    <aside class="thread-list">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æ—¥ä»˜ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢"
               onkeydown="if(event.key==='Enter'){event.preventDefault(); searchThreads();}">
      </div>
      <small class="search-hint">å…¥åŠ›ã—ã¦[Enterã‚­ãƒ¼]ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>

      <div class="thread-scroll" id="thread-list"></div>

      <div class="button-stack">
        <button class="create-btn" onclick="openNewThread()">ï¼‹ æ–°ã—ã„æ²ç¤ºæ¿ã‚’ç«‹ã¦ã‚‹</button>
        <button class="delete-btn" onclick="openDeleteModal()">ğŸ—‘ï¸ æ²ç¤ºæ¿ã‚’å‰Šé™¤</button>
      </div>
    </aside>

    <section class="thread-detail">
      <div id="thread-detail-content"><p>ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p></div>
    </section>
  </main>

  <div id="createModal" class="modal-backdrop">
    <div class="modal-content">
      <h3>æ–°ã—ã„æ²ç¤ºæ¿ã‚’ä½œæˆ</h3>
      <input type="text" id="newTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«"
             style="width:100%;margin-bottom:10px;padding:5px; box-sizing: border-box;"/>
      <textarea id="newMsg" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
      <label style="margin-top:10px; display: block;">ğŸ“· ç”»åƒã‚’æ·»ä»˜ï¼š<input type="file" id="newImage" accept="image/*"></label>
      <div class="anonymous-toggle">
        <input type="checkbox" id="newAnon" />
        <label for="newAnon">åŒ¿åã§æŠ•ç¨¿</label>
      </div>
      <div style="text-align:right;margin-top:10px;">
        <button class="btn-send" style="background:#6c757d" onclick="closeModal('#createModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-send" id="createBtn" onclick="createThread()">ä½œæˆ</button>
      </div>
    </div>
  </div>

  <div id="deleteModal" class="modal-backdrop">
    <div class="modal-content">
      <h3>ğŸ—‘ï¸ æ²ç¤ºæ¿ å‰Šé™¤ç¢ºèª</h3>
      <p>ã“ã®æ²ç¤ºæ¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚è¿”ä¿¡ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeModal('#deleteModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn confirm" id="confirmDeleteBtn" onclick="deleteThreadConfirm()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    let currentThreadId=null,currentUser=null;
    const csrfToken = document.querySelector('meta[name="_csrf"]').content; // â˜… CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content; // â˜… CSRFãƒ˜ãƒƒãƒ€ãƒ¼åã‚’å–å¾—

    document.addEventListener("DOMContentLoaded",async()=>{
      try{const r=await fetch("/api/users/me");if(r.ok)currentUser=await r.json();}catch(e){console.warn("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—",e);}
      await loadThreads();
      const id=new URLSearchParams(location.search).get('threadId');
      if(id)await showThreadById(id);
    });

    async function loadThreads(){
      try{
        const r=await fetch("/api/thread/list");
        if(!r.ok)throw new Error();
        renderThreads(await r.json());
      }catch(e){document.getElementById("thread-list").innerHTML="<p>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";}
    }

    function renderThreads(threads){
      const list=document.getElementById("thread-list");
      list.innerHTML="";
      (threads || []).forEach(t=>{ // â˜… null ãƒã‚§ãƒƒã‚¯è¿½åŠ 
        const d=document.createElement("div");
        d.className="thread-item"; d.dataset.threadId=t.threadId;
        const icon=t.anonymous?"/images/default_icon.png":(t.icon||"/images/default_icon.png");
        d.innerHTML=`<img src="${icon}" class="thread-icon">
          <div class="thread-info"><div class="thread-title">${t.title || ''}</div>
          <div class="thread-meta">${t.userName || 'ä¸æ˜'}ãƒ»${t.timestamp || ''}</div></div>`;
        d.onclick=()=>{history.pushState({threadId:t.threadId},'',`?threadId=${t.threadId}`);showThread(t);};
        list.appendChild(d);
      });
    }

    async function searchThreads(){
      const kw=document.getElementById("searchInput").value;
      try {
        const r=await fetch(`/api/thread/search?keyword=${encodeURIComponent(kw)}`);
        if(!r.ok) throw new Error('Search failed');
        renderThreads(await r.json());
      } catch(e) {
        document.getElementById("thread-list").innerHTML="<p>æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
      }
      document.getElementById("thread-detail-content").innerHTML="<p>ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>";
      currentThreadId=null;
    }

    async function showThreadById(id){
      try{
        const r=await fetch(`/api/thread/${id}`);
        if(!r.ok)throw new Error();
        showThread(await r.json());
      }catch{document.getElementById("thread-detail-content").innerHTML="<p>èª­ã¿è¾¼ã¿å¤±æ•—ã€‚</p>";}
    }

    function showThread(t){
      if (!t) { // â˜… null ãƒã‚§ãƒƒã‚¯è¿½åŠ 
         document.getElementById("thread-detail-content").innerHTML="<p>ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
         return;
      }
      currentThreadId=t.threadId;
      document.querySelectorAll('.thread-item').forEach(i=>{
        i.classList.toggle('active',i.dataset.threadId===t.threadId);
      });
      const d=document.getElementById("thread-detail-content");
      const icon=t.anonymous?"/images/default_icon.png":(t.icon||"/images/default_icon.png");
      // â˜… ä¿®æ­£: ç”»åƒè¡¨ç¤ºã‚’ imageUrl ã«å¤‰æ›´ã—ã€ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º
      const imageHtml = t.imageUrl ? `<img class="thread-image" src="${t.imageUrl}" onclick="window.open('${t.imageUrl}')">` : "";

      d.innerHTML=`<div class="thread-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="${icon}" class="thread-icon" style="width:50px;height:50px;">
          <div><h2 style="margin:0;">${t.title || ''}</h2>
          <p class="thread-meta">${t.userName || 'ä¸æ˜'}ãƒ»${t.timestamp || ''}</p></div></div>
        <p style="white-space:pre-wrap;margin-top:10px;">${t.message || ''}</p>
        ${imageHtml}</div>`; // â˜… ä¿®æ­£ç®‡æ‰€

      if(t.replies?.length){
        t.replies.forEach(r=>{
          const ic=r.anonymous?"/images/default_icon.png":(r.icon||"/images/default_icon.png");
          d.insertAdjacentHTML("beforeend",`<div class="reply"><div style="display:flex;gap:10px;">
            <img src="${ic}" class="thread-icon" style="width:35px;height:35px;">
            <div><p style="white-space:pre-wrap;">${r.message || ''}</p>
            <p class="reply-meta">${r.userName || 'ä¸æ˜'}ãƒ»${r.timestamp || ''}</p></div></div></div>`);
        });
      }
      d.insertAdjacentHTML("beforeend",`<div class="form-section" style="margin-top:20px;border-top:1px solid #eee;padding-top:15px;">
        <h4>è¿”ä¿¡ã™ã‚‹</h4>
        <textarea id="replyMsg" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <div class="anonymous-toggle"><input type="checkbox" id="replyAnon"><label for="replyAnon">åŒ¿åã§è¿”ä¿¡</label></div>
          <button class="btn-send" onclick="sendReply('${t.threadId}',this)">è¿”ä¿¡</button>
        </div></div>`);
    }

    function openNewThread(){document.getElementById("createModal").style.display="flex";}
    function closeModal(id){document.querySelector(id).style.display="none";}
    function openDeleteModal(id){
      if(id)currentThreadId=id;
      if(!currentThreadId){alert("å‰Šé™¤ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");return;}
      // â˜… å‰Šé™¤æ¨©é™ãƒã‚§ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ: ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹å‰æ)
      const threadData = findThreadDataById(currentThreadId); // ç¾åœ¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (è¦å®Ÿè£… or findById å†åˆ©ç”¨)
      if (threadData && currentUser && threadData.authorId !== currentUser.userId) {
          alert("è‡ªåˆ†ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã—ã‹å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
          return;
      }
      document.getElementById("deleteModal").style.display="flex";
    }

    // â˜… è¿½åŠ : currentThreadId ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (ãƒªã‚¹ãƒˆå†æç”»ã‚’é¿ã‘ã‚‹ãŸã‚)
    function findThreadDataById(id) {
        // ã“ã®å®Ÿè£…ã¯ã€renderThreads ã§ä½¿ã£ã¦ã„ã‚‹å…ƒãƒ‡ãƒ¼ã‚¿ (fetch çµæœ) ã‚’ä¿æŒã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹
        // ã‚‚ã—ä¿æŒã—ã¦ã„ãªã„å ´åˆã¯ã€å†åº¦ /api/thread/{id} ã‚’ fetch ã™ã‚‹
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã« null ã‚’è¿”ã™ä¾‹
        return null; // TODO: ã‚¹ãƒ¬ãƒƒãƒ‰ãƒªã‚¹ãƒˆã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
    }

    async function deleteThreadConfirm(){
      if(!currentThreadId)return;
      const b=document.getElementById("confirmDeleteBtn");
      b.disabled=true;b.textContent="å‰Šé™¤ä¸­...";
      try{
        const r=await fetch(`/api/thread/${currentThreadId}`,{
            method:"DELETE",
            headers:{[csrfHeader]:csrfToken} // â˜… CSRFãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        });
        if(!r.ok)throw new Error(await r.text() || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        closeModal('#deleteModal');await loadThreads();
        document.getElementById("thread-detail-content").innerHTML="<p>ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>";
        history.pushState(null,'',location.pathname);currentThreadId=null;
      }catch(e){
          console.error("Delete Error:", e);
          alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼')); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ”¹å–„
      }
      finally{b.disabled=false;b.textContent="å‰Šé™¤ã™ã‚‹";}
    }

    // â˜…â˜…â˜… createThread é–¢æ•°ã‚’ä¿®æ­£ â˜…â˜…â˜…
    async function createThread(){
      const b=document.getElementById("createBtn");
      b.disabled=true; b.textContent="ä½œæˆä¸­...";
      const title = document.getElementById("newTitle").value;
      const msg = document.getElementById("newMsg").value;
      const anon = document.getElementById("newAnon").checked;
      const file = document.getElementById("newImage").files[0];

      if (!title || !msg) {
        alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        b.disabled = false; b.textContent = "ä½œæˆ";
        return;
      }

      try {
        let imageUrl = null; // ç”»åƒURLã‚’åˆæœŸåŒ–

        // 1. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã€å…ˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        if (file) {
          const formData = new FormData();
          formData.append('file', file);

          const uploadResponse = await fetch("/api/thread/upload", {
            method: "POST",
            headers: { [csrfHeader]: csrfToken }, // CSRFãƒ˜ãƒƒãƒ€ãƒ¼
            body: formData
          });

          if (!uploadResponse.ok) {
            const errorData = await uploadResponse.json();
            throw new Error(errorData.error || 'ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
          const uploadResult = await uploadResponse.json();
          imageUrl = uploadResult.imageUrl; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœã‹ã‚‰URLã‚’å–å¾—
        }

        // 2. ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆAPIã‚’å‘¼ã³å‡ºã™ (imageUrlã‚’å«ã‚ã‚‹)
        await sendThread(title, msg, anon, imageUrl);

      } catch(e) {
         console.error("Create Thread Error:", e);
         alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      } finally {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        closeModal('#createModal');
        document.getElementById("newTitle").value = "";
        document.getElementById("newMsg").value = "";
        document.getElementById("newAnon").checked = false;
        document.getElementById("newImage").value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
        b.disabled = false; b.textContent = "ä½œæˆ";
        await loadThreads(); // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
      }
    }

    // â˜…â˜…â˜… sendThread é–¢æ•°ã‚’ä¿®æ­£ â˜…â˜…â˜…
    async function sendThread(title, msg, anon, imgUrl){ // å¼•æ•°ã‚’ imgUrl ã«å¤‰æ›´
      const payload = {
          title: title,
          message: msg,
          anonymous: anon,
          imageUrl: imgUrl // imageBase64 ã®ä»£ã‚ã‚Šã« imageUrl ã‚’é€ä¿¡
      };

      const r = await fetch("/api/thread/create", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken // CSRFãƒ˜ãƒƒãƒ€ãƒ¼
          },
          body: JSON.stringify(payload)
      });

      if(!r.ok) throw new Error(await r.text() || "ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");

      const nt = await r.json();
      // closeModal('#createModal'); // createThread å´ã§é–‰ã˜ã‚‹ã‚ˆã†ã«å¤‰æ›´
      // await loadThreads(); // createThread å´ã§å‘¼ã¶ã‚ˆã†ã«å¤‰æ›´
      history.pushState({threadId:nt.threadId},'',`?threadId=${nt.threadId}`);
      showThread(nt); // ä½œæˆã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ã™ãã«è¡¨ç¤º
    }

    async function sendReply(id,btn){
      btn.disabled=true;btn.textContent="è¿”ä¿¡ä¸­...";
      try{
        const msg=document.getElementById("replyMsg").value; // IDã‚»ãƒ¬ã‚¯ã‚¿ä¿®æ­£
        const anon=document.getElementById("replyAnon").checked; // IDã‚»ãƒ¬ã‚¯ã‚¿ä¿®æ­£
        if(!msg){alert("è¿”ä¿¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");return;}

        const r=await fetch(`/api/thread/${id}/reply`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                [csrfHeader]:csrfToken // â˜… CSRFãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
            },
            body:JSON.stringify({message:msg,anonymous:anon})});
        if(!r.ok)throw new Error(await r.text() || "è¿”ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
        await showThreadById(id); // è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¿”ä¿¡ã‚’è¡¨ç¤º
        // await loadThreads(); // ãƒªã‚¹ãƒˆã®æ›´æ–°ã¯é€šå¸¸ä¸è¦
      }catch(e){
          console.error("Reply Error:", e);
          alert("è¿”ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      }
      finally{btn.disabled=false;btn.textContent="è¿”ä¿¡";}
    }
  </script>
</body>
</html>